---
title: "11-监督学习：回归"
author: "王梓安"
date: "2025-03-22"
output:
  rmarkdown::html_document:
    toc: true # 开启目录
    toc_depth: 6 # 目录深度
    toc_float: true # 让目录浮动在左侧
    number_sections: false # 不自动生成目录
    code_download: true # 启用一键下载功能
    theme: cerulean
    highlight: pygments
    css: custom.css # 添加自定义CSS文件
    includes:
      in_header: header.html # 引入自定义HTML/JS文件
---

监督学习是机器学习中最常见的一种，它经常和预测性分析联系在一起。监督学习有两个主要的研究问题：回归和分类。其中，回归能有效预测定量数值，例如产品销售收入、房屋价格、通货膨胀率等。这种方法已经存在了很长时间了。和其他受数据科学家欢迎的算法相比，虽然学习这种算法看起来有些单调乏味，但是回归依然是监督机器学习的主力，它非常有用并且也广泛使用。

在学习更复杂的工具之前，对回归算法有充分了解，将有利于你掌握机器学习工具。

在学习回归算法时，我们需要思考跟手头项目有关的几个重要问题，例如：

-   预测的变量（因变量）和用于预测的变量（自变量）之间有关系吗？更进一步，它们之间的关系有多强？预测结果具有很高的精度吗？

-   哪些可用的特征变量（自变量）对预测有帮助？每个变量贡献多少？使用这些特征变量能使预测到达怎样的精度？

-   它们的关系是线性的吗？还是非线性的？

## 11.1 回归类模型概述

传统统计学当中，一般会对多个组的样本参数进行比较以完成对总体间对应变量关系的估计。而在对多个组的样本进行比较之前，我们需要先描述各个组的分布特征，也就是建模；而对多个组的样本进行建模时，我们需要基于**描述样本分布的三大特征（集中趋势、离散趋势、形态）**，使用模型公式进行量化描述。

![模型表达式和数据结构](E:\DataAnalysis\vscodeProject\study\attachments\模型表达式和数据结构.png)

### 11.1.1 基础模型

我们假设一个高考生想根据未来薪资选择职业，其备选项分为律师、医生和程序员，通过对身边人的调查，其得到了三组样本。而为了描述这三个样本，需要拟合出一个同样的公式（模型）。通用模型框架如下：

$x_{i j}=\mu_{i}+\varepsilon_{i j}$

其中，i表示第几组，j表示每组中的第j个个体。xij表示观测变量（因变量）收入水平，在这个例子里观测变量只受到一类变量影响那就是职业群体的不同：在一个统计分析中，我们进行控制的因素、进而通过这个因素控制观测变量（因变量），这样的因素就是控制因素（自变量），在这个例子中，职业是一个分类自变量、分为了三个水平（level），因此代表控制因素（自变量）的符号是i。$\mu_{i}$表示每个组的集中趋势（平均值），$\varepsilon_{i j}$表示每个组的离散趋势（方差）。

### 11.1.2 基础模型+参照水平（拟合的约束条件）

为了进一步分析的方便，一般都会寻找一个均数的参照水平，将其余组的平均水平与之相比：

$x_{i j}=\mu+\alpha_{i}+\varepsilon_{i j}$

显然，这样的组合会有许多种，因此模型在实际分析的时候往往会加上一些实际条件，比如假设参照水平是最后一个组的均数，这被称为拟合的约束条件：即$\mu$为基准均值（集中趋势），$\alpha_{i}$表示各组的均值差异，二者相加等于各个组的集中趋势特征。

**参照水平**$\mu$的意义在于比较各个组间（水平）的差异。

### 11.1.3 基础模型+组间参照水平（拟合的约束条件）+组内离散水平（各组的数据变异程度/标准差）

在常见的研究中，我们更关心各组均数的差别，对于标准差的差别则比较忽视：因此在基本的方差分析模型（传统模型）中，往往将不同组的$\varepsilon_{i j}$假设为服从相同的正态分布（就是说相同的标准差）：

$x_{i j}=\mu+\alpha_{i}+\varepsilon_{i j}$

$\varepsilon_{i j}\sim\left(0, \delta^{2}\right)$

注意：**在后来发展的混合效应模型和多水平模型中，不仅仅只关注组间差异，各组的离散程度的差异也进入了研究视野，此时模型不一定会加入此限制**。具体到这个例子中，可能律师的职业平均收入较高，但是其组内的分布表现出不同个体之间的收入差异很大，好的很好、低的很低，那这个时候从稳妥的角度考虑，选择一个个体收入差异波动没那么明显的职业也是很好的选择、即使可能这个职业的平均收入不如律师。

## 11.2 使用模型解决实际问题

### 11.2.1 对上述标准模型进行实际应用的扩展

仍然基于职业选择的例子进行说明：

$x_{i j}=\mu+\alpha_{1}+\alpha_{2}+\alpha_{3}+\varepsilon_{i j}$

-   如果职业1和职业2的平均收入不相等，则应当有a1≠a2；此时虚无假设H0:a1=a2

-   如果三种职业的平均收入无差异，则应当有a1=a2=a3=0，此时如果采用适当的参照水平$\mu$（即某个组的均值作为基准均值）；就有H0：$\alpha_{i}=0$，H1：至少有一个$\alpha_{i}≠0$。

当然，即便证明了H1，也不能说明这几个职业的收入平均水平谁高谁低，还需要进行**事后比较**才行。

### 11.2.2 进一步加入（新的）连续自变量的影响

如果在原本的模型中加入新的变量会产生什么影响呢？例如，如果进一步考虑孩子的高考成绩昵：

$x_{i j}=\mu+\alpha_{i}+\beta*\text { score }+\varepsilon_{i j}$

展开后变成：

$x_{i j}=\mu+\alpha_{1}+\alpha_{2}+\alpha_{3}+\beta*\text { score }+\varepsilon_{i j}$

显然，模型假定高考成绩和职业收入间存在线性关系。

## 11.3 一般线性模型（GLM）：传统统计学视角

### 11.3.1 表达式

$x_{i j}=(\mu+\alpha_{1}+\alpha_{2}+\alpha_{3})+\beta*\text { score }+\varepsilon_{i j}$

上述公式就是一般线性模型（GLM）的通式。其中，$(\mu+\alpha_{1}+\alpha_{2}+\alpha_{3})$表示以分类影响因素为主的情况，score表示以连续变量影响因素为主的情况。在不同的应用分析中，一般线性模型有不同的变体，但都依赖于线性回归模型的大框架：

-   方差分析模型（以分类影响因素为主的情况）

-   线性回归模型（以连续变量影响因素为主的情况）

### 11.3.2 GLM使用条件

$x_{i j}=(\mu+\alpha_{1}+\alpha_{2}+\alpha_{3})+\beta*\text { score }+\varepsilon_{i j}$

-   (连续)数值因变量：因为$\varepsilon_{i j}$（误差项）表示各个样本的离散特征（样本本身的变异性）符合正态分布，因此正态分布的因变量肯定是连续变量
-   线性关联：这一点实际上特指连续自变量$\beta*\text { score }$，因为$(\mu+\alpha_{1}+\alpha_{2}+\alpha_{3})$的部分本身是分类影响因素，和连续变量也不沾边
-   残差($\varepsilon_{i j}$)必须服从同一个正态分布（线性回归模型正是建立在这样的假设上的）
    -   正态性：残差满足正态分布，这导致了$(\mu+\alpha_{1}+\alpha_{2}+\alpha_{3})$分类变量的各组必须满足正态分布，也即自变量必须满足正态分布
    -   方差齐性：残差满足同一个正态分布，这导致分类变量必须具有相同的方差
    -   独立性(无关联/非共线)：残差之间**无关联**（各个组自身的变异性不会互相影响），自变量之间**没有共线性**（即自变量之间没有相关性）

可以看出，GLM的限制条件中，除了连续变量影响因素所导致的线性关系限制以外，其他的两点限制和残差$\varepsilon_{i j}$都有关系。

而在实践中，更复杂的**连续因变量**（因变量还得连续，不然就不是回归问题了）模型，基本上都是针对上述某个条件被违反的各种情形所做的模型修正/改进。

## 11.4 基于(线性)回归模型的变体

### 1.数据抽屉

+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------+
| 数据状况                                                                                                                                                                                                                                                                                                                            | 应对模型                                                                                                                                         | R函数/包                                     |
+=====================================================================================================================================================================================================================================================================================================================================+==================================================================================================================================================+==============================================+
| 数据为理想状态                                                                                                                                                                                                                                                                                                                      | 线性回归模型/一般线性模型                                                                                                                        | `lm()`                                       |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  | `glm()`                                      |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------+
| -   非线性关联(因变量和自变量存在非线性关系)                                                                                                                                                                                                                                                                                        | 曲线直线化                                                                                                                                       | `poly()`                                     |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
| -   存在高次项（因变量和自变量曲线关联）                                                                                                                                                                                                                                                                                            | 多项式回归                                                                                                                                       | `splines::ns()`                              |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
| -   交互项（存在两个或多个自变量之间的相互作用对因变量的影响，这既要关注到自变量之间可能存在非线性关系，也要关注自变量之间的关系产生的交互效应对因变量的影响）                                                                                                                                                                      |                                                                                                                                                  | `lm()` (使用`poly()`生成多项式项)            |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  | `splines::ns()`                              |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  | `lm()` (使用交互项，如`x1*x2`)               |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------+
| （自变量很多的情况）自变量筛选                                                                                                                                                                                                                                                                                                      | -   逐步回归（这个是保留自变量中具有统计学意义的变量，这个功能R里有）                                                                            | -   `step()` \| `MASS::stepAIC()`            |
|                                                                                                                                                                                                                                                                                                                                     | -   最小角回归（LARS）                                                                                                                           | -   `lars::lars()`                           |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------+
| 自变量存在共线性[1]                                                                                                                                                                                                                                                                                                                 | 岭回归（损失信息，找到每个自变量的回归系数）                                                                                                     | `glmnet::glmnet()`                           |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
|                                                                                                                                                                                                                                                                                                                                     | Lasso回归（找到最重要的那几个自变量，其余的踢出方程）                                                                                            | `MASS::truehist()`                           |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
|                                                                                                                                                                                                                                                                                                                                     | 弹性网络（岭回归+Lasso回归）                                                                                                                     | `glmnet::glmnet()`                           |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
|                                                                                                                                                                                                                                                                                                                                     | 偏最小二乘法（PLS）（提取公因子）                                                                                                                | `glmnet::cv.glmnet()`                        |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  | `glmnet::glmnet()`                           |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  | `glmnet::cv.glmnet()`                        |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  | `pls::plsr()`                                |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------+
| [残差方差不齐]{style="color:orange"}                                                                                                                                                                                                                                                                                                | [加权最小二乘法（给不同残差大小的案例不同权重，使得模型拟合效果达到最优）]{style="color:orange"}                                                 | `stats::lm()` (使用`weights`参数)            |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------+
| [残差自相关[2]（各个组组内的变异性受到自身影响）——即模型误差=可以解释的误差+无法解释的误差；因为模型拟合不足，导致有一部分可解释误差的规律没有被挖掘而进入残差，变成了残差之间的某种联系。简言之，就是残差存在某些内在规律没有被挖掘出来，而表现出残差内部存在有规律的特征与联系，这种问题常见于时间序列数据]{style="color:orange"} | [自回归（残差自相关/不独立）]{style="color:orange"}                                                                                              | `nlme::gls()`                                |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
| [残差不独立[3]（不同组组间的变异性互相影响）]{style="color:orange"}                                                                                                                                                                                                                                                                 | [混合线性模型（直接研究残差自相关或独立性，也就是研究残差的相关的矩阵是怎样的，即残差的关联性到底怎样）]{style="color:orange"}                   | `stats::arima()`                             |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
| 残差自相关和残差不独立的区别和联系：                                                                                                                                                                                                                                                                                                | [GEEs（想消除数据非独立(残差非独立)对其他参数的影响，得到更稳健的参数估计(更稳健的均值估计or回归系数估计)）]{style="color:orange"}               | `nlme::lme()`                                |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
| -   残差自相关是一种特殊类型的残差不独立性，指的是残差之间存在时间或空间上的相关性。                                                                                                                                                                                                                                                |                                                                                                                                                  | `lme4::lmer()`                               |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
| -   残差不独立则是更广泛的概念，表示不同观测值之间的误差项彼此之间存在依赖关系。                                                                                                                                                                                                                                                    |                                                                                                                                                  | `geepack::geeglm()`                          |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------+
| [存在强影响点（高杠杆点）/异常值：如果是数据挖掘遇到这种情况，一般1、直接将其剔除；2、或者是另归为一类情况讨论]{style="color:orange"}                                                                                                                                                                                               | [稳健回归（对于传统统计学，可以使用最小一乘法、中位数回归等对于离群值、强影响点不那么敏感的方法来代替最小二乘法进行统计）]{style="color:orange"} | `MASS::rlm()`                                |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------+
| 因变量为分类变量（因变量是分类变量实际上应该是监督学习里的分类问题，但也可以使用回归方法进行处理）                                                                                                                                                                                                                                  | Logistic回归                                                                                                                                     | `stats::glm()` (使用`family="binomial"`)     |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
|                                                                                                                                                                                                                                                                                                                                     | 岭回归分类（使用岭回归进行分类是一种组合方法，是为后续进一步的数据分析打基础的，并非独立的方法）                                                 | `glmnet::glmnet()` (用于分类)                |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  | `glmnet::glmnet()` (使用`family="binomial"`) |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------+
| 自变量为时间顺序                                                                                                                                                                                                                                                                                                                    | 时间序列模型                                                                                                                                     | `stats::arima()`                             |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------+
| [多种问题的混合：]{style="color:orange"}                                                                                                                                                                                                                                                                                            | [最优尺度回归（python里面没有，SPSS、SAS里面有非常完备的最优尺度回归方法）]{style="color:orange"}                                                | `rock` 包                                    |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
| [（因变量和自变量为非线性关系）非线性]{style="color:orange"}                                                                                                                                                                                                                                                                        |                                                                                                                                                  |                                              |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
| [很多分类自变量]{style="color:orange"}（这个是主要问题点，当主要出现这个特征时，就需要考虑最优尺度回归了）                                                                                                                                                                                                                          |                                                                                                                                                  |                                              |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
| [数据分布异常]{style="color:orange"}                                                                                                                                                                                                                                                                                                |                                                                                                                                                  |                                              |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------+
| [多种问题的混合：]{style="color:orange"}                                                                                                                                                                                                                                                                                            | [路径分析]{style="color:orange"}                                                                                                                 | --                                           |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
| [数据非独立（数据本身有关联性）]{style="color:orange"}                                                                                                                                                                                                                                                                              | [结构方程模型（SPSS+AMOS、SAS、EQS）]{style="color:orange"}                                                                                      | `lavaan::sem()`                              |
|                                                                                                                                                                                                                                                                                                                                     |                                                                                                                                                  |                                              |
| [自变量间存在复杂联系]{style="color:orange"}                                                                                                                                                                                                                                                                                        |                                                                                                                                                  |                                              |
+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------+

以上是单因变量（一个因变量有多个分类也是一个因变量）的回归模型的分析采用框架。而当有多个因变量的时候，基本上是两种思路：

-   将多个因变量合成为一个因变量

-   对多个因变量建立复杂的结构方程模型

### 2.拓展索引

[1]共线性和交互作用的差异

1、自变量之间的共线性： 指两个或多个自变量之间存在高度相关性，这种相关性会导致回归模型中的参数估计不稳定（导致回归系数的不稳定性和高方差模型的解释(预测)能力差等问题），可能导致模型难以解释，因为难以区分各自变量的独立贡献。解决方法一般为移除高度相关的自变量、使用正则化方法（如岭回归、Lasso回归）、使用主成分分析（PCA）等降维技术。 正因为传统统计学的回归模型中，不同（组）的变量之间存在正态分布、方差齐性、非共线性等限制，残差（方差）作为描述变量的属性，也会被这些条件所限制。

2、自变量之间的交互效应： 交互效应用于捕捉自变量之间的相互作用，以及这种作用如何影响因变量；交互效应可以揭示更复杂的关系和模式，其需要在模型中显式（以公式的形式）地包含交互项。

*参数估计与正则化在这里的引用*

我们之前提到了参数估计和正则化的概念：参数估计就是估计模型中的最优参数，保证模型（在训练集中）拟合优秀；正则化就是尽可能保证参数估计准确的前提下尽量减少变量个数，防止变量之间可能存在的共线性等问题对参数估计造成影响，影响模型的解释（预测）能力。

从建模的角度简单的讲，自变量间的共线性影响模型稳定性和解释力，而自变量间的交互效应彰显更加复杂的关系、有研究价值。那如何区分自变量之间存在的是共线性还是交互效应？ - 共线性：如果相关系数矩阵中存在高度相关的自变量，或者VIF值较高，则说明存在共线性问题。共线性会导致回归系数的不稳定性和高方差，影响模型的解释力和预测能力。 - 交互效应：如果引入交互项后的回归模型中，交互项的系数显著，则说明存在交互效应。交互效应揭示了自变量之间的相互作用对因变量的影响，能够捕捉更复杂的关系和模式。

[2][3]残差自相关/残差不独立

残差的概念涉及两个层面：传统统计学和数据科学。从传统统计学推导出的回归模型角度看，残差项实际上是分类变量（不同组）形成的各个组的方差，此时的方差表示的是样本参数与总体统计量之间的误差——在传统统计学的回归模型中，由于需要满足许多假设，因此不同组间的方差应该是一样的。而从数据挖掘的角度看，残差是模型预测值和实际值之间的差距。

因此，理解数据科学中的许多模型，你都要有两个学科的概念，统计学的原理告诉你为什么残差（某个概念）会有一些性质或限制（回归模型有正态分布、方差齐性、非共线等限制，其本质上都是残差的存在导致的），数据科学告诉你这个概念在实际分析中代表的实际意义（比方说残差代表模型预测值和实际值之间的差距）。

残差自相关和残差不独立是回归分析中常见的两个概念，主要用于描述模型中残差（即预测值与真实值之间的差距）的特性：

1、残差自相关 (Residual Autocorrelation)

残差自相关是指残差序列中的一个残差与其前后（时间、空间上的近邻性）其他残差之间存在相关性。当残差之间存在某种模式或规律性时，残差就被认为是自相关的：在时间序列分析中，如果模型没有捕捉到某些趋势或周期性，残差就可能具有自相关性——例如，假设在某一时刻的残差与前一时刻的残差存在某种关系（如相关性），那么这种现象就称为残差自相关。

残差自相关违反了回归分析中的一个假设——即残差是"独立同分布(i.i.d.)"：**如果残差存在自相关，说明模型没有完全解释数据中的某些结构或趋势。**

*什么是独立同分布*

独立同分布和方差齐性乍一听有点像，因为都涉及对数据分布特征的限制，但二者有区别——它们的区别和关系就像残差不独立（大概念）和残差自相关（小概念）的区别和关系，即大包小的关系：

1、独立同分布 (i.i.d.)： 这个概念指的是一组随机变量是独立的，并且每个随机变量都遵循相同的概率分布。具体来说：

-   独立性：每个随机变量的取值不受其他随机变量的影响。

-   同分布：所有随机变量遵循相同的概率分布，即它们具有相同的分布类型和参数（如均值和方差）。 在回归分析中，通常假设误差项是独立同分布的，即各个观测（各个数据点）的误差不相互关联，并且它们具有相同的分布特征。

2、方差齐性 (Homoscedasticity)：

-   方差齐性指的是在回归模型中，所有的观测值的误差项（残差）具有相同的方差。换句话说，误差项的波动程度在所有的观测中是恒定的。

-   方差齐性是回归模型假设的一部分，意味着回归模型的残差不会随着自变量的变化而呈现出逐渐增大或减小的趋势。如果残差的方差随着自变量的变化而变化，这种现象被称为异方差性（Heteroscedasticity）。

总结

-   独立同分布要求误差项相互独立并且来自相同的分布，而方差齐性要求这些误差项具有相同的方差————它们都涉及对误差项的假设，但独立同分布的假设比方差齐性的假设更为严格；因为方差齐性是描述误差项方差的一种情况，而独立同分布是描述误差项之间关系的一种情况。

2、残差不独立 (Non-independence of Residuals)

残差不独立指的是不同观测值（数据点）的残差之间存在一定的依赖关系，即某些残差可能与其他残差相关联。与“独立性假设”相反，残差不独立意味着残差之间存在某种模式或相互作用。

在回归分析中，假设残差是独立的，即每个观测的误差项（变异性）不受其他观测值的误差项（变异性）影响。残差不独立可能源于数据中的潜在模式或变量之间的相互依赖，导致回归模型的误差项不独立。

区别：

-   残差自相关是一种特殊类型的残差不独立性，指的是残差之间存在时间或空间上的相关性。

-   残差不独立则是更广泛的概念，表示不同观测值之间的误差项彼此之间存在依赖关系。

总结：

在回归模型中，残差自相关或不独立可能表明模型缺少某些重要变量或未能正确捕捉数据的某些结构（如时间序列中的趋势或季节性），通常需要通过改进模型或采用时间序列分析方法（如ARIMA模型）来处理这种情况。

## 11.5 线性回归模型回顾：从数据科学视角

### 11.5.1 线性回归模型的价值

1、研究一个连续性变量(因变量)的取值随着其它变量(自变量)的数值变化而变化的趋势。

2、通过回归方程解释两变量之间的关系显的更为精确，可以计算出自变量改变一个单位时因变量平均改变的单位数量，这是**相关分析**无法做到的。

3、除了描述两变量的关系以外，通过回归方程还可以进行预测和控制（即将因变量限制在某一水平，看看对应情况下自变量要如何调整才能控制因变量在这一水平），这在实际工作中尤为重要。

### 11.5.2 线性回归模型的基本框架

**11.4部分的推导公式具备同样的原理，那样的表述是基于传统假设检验的视角（需要分组实验）进行推导的；而对于数据科学(挖掘)方向，最好基于下面这样的推演公式。**

**当然，理解还是11.4部分的公式好理解，你如果直接根据11.5部分的公式看，你很难明白为什么变量还需要满足什么正态分布、方差齐性和非共线性（正态分布+方差齐性+非共线性=独立同分布）这些乱七八糟的限制。**

#### 1.Y的估计值的表达（截距项$\alpha$+回归项）

（原教旨）线性回归假定自变量对因变量的影响强度始终保持不变：

$\hat{y}=\alpha+\beta x$

$\hat{y}$：给定自变量的取值时，y的估计值(所估计的平均水平)

-   因变量的预测值可以被分解成两部分：常量+回归部分

a（总体、实际值）/$\alpha$常量(constant)：自变量x取值**均为零（有时可能有多个自变量）**时y的平均估计量

-   可以被看成是一个基线水平

-   多数情况下没有实际意义，研究者也不关心

b（总体、实际值）$\beta$(偏)回归系数：**自变量x改变一个单位，y估计值的改变量**

-   因变量Y的变异中，可以由X直接估计的部分

-   一般称其为回归系数，如果是多自变量模型，应该称其为偏回归系数（为什么呢？偏回归系数是多元线性回归模型中的一个重要概念，它表示在控制其他自变量不变的情况下，一个特定自变量对因变量的影响程度；偏回归系数反映了每个自变量对因变量的独立贡献，因而有个“偏”字）

#### 2.Y的实测值的表达（截距项$\alpha$+回归项+误差项$e_{i}$）

$y_{i}=a+b x+e_{i}$

$e_{i} \sim N\left(0, \sigma^{2}\right)$

```{r eval=FALSE, warning=FALSE}
注意：这里的截距项写成a，回归系数写成b，误差项写成ei；这种英文字母的表述象征着这是描述真实值/总体的公式参数，而希腊字母表示的是描述估计值/样本的公式参数。

为什么我之前对统计学的概念云里雾里，因为很多教程和讲解往往是将基于假设检验推导的回归模型和基于数据挖掘这种缺乏样本概念的学科视角推导的回归模型混着讲，原理从假设检验的角度去推导，具体分析案例的时候又直接引入截距、误差项（有的具备交互效应的模型可能还有个交互项）这种明显从数据挖掘视角出发、不依赖样本推总体的回归模型概念。

然而实际上面对不同领域，就应该从不同的角度去理解，混着理解混着学就是狗屁不通的学究做派，傻逼讲究害了学生；应当根据需求，泾渭分明地去认识、理解同一个事物，具体问题、具体应用、具体分析、具体解决。
```

关于$e_{i} \sim N\left(0, \sigma^{2}\right)$：

$e_{i}$：估计值和每一个实测值之间的差被称为残差。它刻画了因变量y除了自变量x以外的其它所有未进入该模型、或未知但可能与y有关的随机和非随机因素共同引起的变异，即不能由x直接估计的部分。

-   为了方程可以得到估计（传统统计学的限制），往往假定$e_{i}$服从正态分布$N\left(0, \sigma^{2}\right)$：注意，这并不是说$e_{i}$真的服从正态分布，而是你每取一个自变量x，就会得到不同的$e_{i}$，这些$e_{i}$随着数量的增加，其分布会近似逼近正态分布（记得那个经典的投硬币实验）。
-   作为整体，模型可以对残差的离散程度进行估计：对于个体而言，残差无法求得，因此模型中出现的残差是从整体的角度对残差进行的估计，有些专门的分析（残差分析）还会涉及对残差更精确的估计。

### 11.5.3 线性回归模型中常用的指标

#### 1.决定系数R2

-   模型整体价值的衡量指标
-   相应的相关系数的平方(**因为从相关分析的角度看，回归关系也可以看成是因变量和各个自变量相关性综合**)，用R2表示
-   反映因变量y的全部变异中能够通过回归关系被自变量解释的比例

#### 2.偏回归系数$\beta$/b

-   反映某一个自变量在数量上对因变量的影响强度
-   相应的自变量上升一个单位时，因变量取值的变动情况
-   注意，偏回归系数只能衡量各个自变量对因变量的影响强度，但是各个自变量的偏回归系数之间并无高低之分，这是绝对无法比较的（因为不同变量的量纲、离散程度(变异性)均不一样，比方说变量1是性别，变量2是身高，根本没有可比性）

#### 3.标化偏回归系数:量纲问题

-   用于自变量间重要性的比较
-   标准化偏回归系数解决了不同自变量的量纲差异和离散程度（变异性）差异的影响
-   最终得到的无量纲的数值当然可以用来比较各个自变量的贡献，但是这个系数不能用来预测因变量，因此这个指标也只有评估自变量间重要性这一个作用

## 11.6 回归模型实战

注意：

1、从相关分析的角度看，回归关系也可以看成是因变量和各个自变量相关性综合。这一点很重要，后面要考，请记住。

2、从单纯的数据挖掘的角度看，回归就是在干一件事——找适配模型变量（x1、x2……）最好的参数，让这个模型拟合出的线穿过最多的数据点：即基于确定的因变量/响应变量和确定（数量）的自变量/特征去拟合训练集里的最优参数（回归系数、残差、截距……都是参数啊），有了确定（数量）的变量和确定的参数再去拿去预测（在预测集里检验预测能力）。一个模型的表现有两个方面控制：模型的复杂度和拟合度，复杂度由变量的纬度（个数）表征、我们通过正则化控制变量纬度避免过拟合；拟合度由变量前面的参数决定、我们通过参数估计（其原理是构造损失函数，常见的损失函数指标就是OLS最小二乘法的残差平方和，这个指标最小的时得到的参数就是拟合的最优参数）来不断优化参数直到最优拟合。

### 1 一元线性回归（OLS最小二乘法）

#### 概述：线性回归

线性回归是历史悠久且广泛应用的监督学习算法，其基于预测/特征变量(预测因子)与响应变量(预测的变量)之间存在线性关系的假设，适用于响应变量为定量，预测因子为定量或定性(分类)的情况。算法通过拟合已知的线性函数，基于观测数据（训练集训练）估计"未知"数据（预测集预测）。

在这个例子中，我们需要学习假设函数的一套回归系数以及最常见的拟合模型的方式即最小二乘法（least squares）。

#### 概述：最小二乘法

-   **原理**：通过所有误差项的平方和，获得最小的误差平方值，使预测误差最小化（误差是指实际响应变量/因变量值和预测值的差）
-   **平方原因**：去除负误差值的影响
-   **注意事项**：避免完全拟合训练集，防止（预测集）过拟合的现象

#### (1)模型训练：实际案例——波士顿房价预测

使用MASS库中的Boston数据集进行一元线性回归分析，研究房屋价格(medv)与平均房间数(rm)的关系：

##### 1. 数据准备

```{r}
library(MASS)
# Boston数据集包含波士顿郊区的房屋价格，它有506行观测值和14个变量
data(Boston)  
# 显示变量名
names(Boston)
```

##### 2. 构建线性模型

```{r}
# 波浪字符～的左边是响应变量，模型设定公式的右边是预测因子——在下例中，medv～rm可以读作“medv由rm预测”
# data=Boston，指定了数据存在的数据框
lm1 <- lm(medv ~ rm, data=Boston)
# lm1是存放线性模型拟合结果的R对象：如果展示这个对象，你可以看到原始函数调用和计算出的回归系数（截距Intercept和斜率9.102）：
  # (Intercept)截距项是-34.671。这个值表示当rm（平均房间数）为0时，medv（房屋中位数价格）的预测值是-34.671。这个值通常没有实际意义（因为房间数不太可能为0），但它在回归模型中是计算其他值的必要部分。
  # rm：回归系数是 9.102。这个值表示每增加一个房间，房屋的中位数价格（medv）会增加 9.102 单位（因为 medv 是以$1000为单位的，所以房价每增加一个房间，预计增加 9,102 美元）。
lm1
```

结果显示回归方程：medv = -34.671 + 9.102 \* rm

##### 3. 模型评估

拟合数据模型的参数后，一个重要的问题是，拟合是否有价值？它能成功地做出预测吗？为了确定这些，可以使用summary()函数来获得一些判断拟合质量的依据：

```{r}
summary(lm1)
```

###### 模型评估：summary全面解读

**残差**

残差是实际观测值与模型预测值之间的差异，理想情况下，残差应随机分布，并且均匀分布在零的两侧。如果残差存在偏斜或异常点，可能表明模型拟合不佳或者数据中存在异常值。

注意：在线性模型中，residuals成分是一个数值向量，**它的长度与数据集中观测数目相同，即每有一个预测值，其和实际值就会产生一个差异（残差）。后面的残差标准误差RSE，是整个模型所有观测对象（特征变量）产生的残差的平均水平，因此是一个唯一值。**

+--------------------------+----------------------------------------------------+------------------------+-------------------------------------------+-----------------------------------------------+----------------------------------------+
| 指标                     | 解释                                               | 理想值                 | 优秀范围                                  | 需改进标准                                    | 优化建议                               |
+==========================+====================================================+========================+===========================================+===============================================+========================================+
| 残差中位数               | 预测误差（残差）的中心趋势                         | 接近0                  | -0.5到0.5                                 | \<-1或\>1                                     | 若显著偏离0：                          |
|                          |                                                    |                        |                                           |                                               |                                        |
|                          |                                                    |                        |                                           |                                               | -   检查模型是否系统性偏差             |
|                          |                                                    |                        |                                           |                                               |                                        |
|                          |                                                    |                        |                                           |                                               | -   考虑添加被忽略的变量               |
|                          |                                                    |                        |                                           |                                               |                                        |
|                          |                                                    |                        |                                           |                                               | -   考虑添加非线性项                   |
+--------------------------+----------------------------------------------------+------------------------+-------------------------------------------+-----------------------------------------------+----------------------------------------+
| 残差范围 (最大值-最小值) | 预测误差（残差）的总体分布范围，反映了：           | 对称分布，接近0        | 对称且范围适中（\<总体标准差的5倍）       | 极值绝对值\>10倍标准差或严重不对称            | 若异常值过大：                         |
|                          |                                                    |                        |                                           |                                               |                                        |
|                          | -   异常值                                         |                        |                                           |                                               | -   检查数据错误、剔除极端异常值       |
|                          |                                                    |                        |                                           |                                               | -   考虑数据转换                       |
|                          | -   模型偏差                                       |                        |                                           |                                               | -   尝试稳健回归方法                   |
+--------------------------+----------------------------------------------------+------------------------+-------------------------------------------+-----------------------------------------------+----------------------------------------+
| 四分位距 (3Q-1Q)         | 预测误差（残差）分布的集中程度，反映了残差分布形状 | Q1和Q3对称且接近中位数 | Q1和Q3相对对称且紧凑（3Q-1Q\<总体标准差） | 高度不对称或范围过大（3Q-1Q＞两倍总体标准差） | 若不对称：                             |
|                          |                                                    |                        |                                           |                                               |                                        |
|                          |                                                    |                        |                                           |                                               | -   检查模型假设                       |
|                          |                                                    |                        |                                           |                                               | -   考虑变量转换[1]                    |
|                          |                                                    |                        |                                           |                                               |     -   非线性变换，一种特殊的变量转换 |
|                          |                                                    |                        |                                           |                                               | -   添加非线性项                       |
|                          |                                                    |                        |                                           |                                               | -   添加新变量                         |
|                          |                                                    |                        |                                           |                                               | -   考虑数据分段建模                   |
+--------------------------+----------------------------------------------------+------------------------+-------------------------------------------+-----------------------------------------------+----------------------------------------+

**估计回归系数**

+---------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+----------------+----------------+--------------------------------+
| 指标                            | 解释                                                                                                                                                                                                                                    | 理想值     | 优秀范围       | 需改进标准     | 优化建议                       |
+=================================+=========================================================================================================================================================================================================================================+============+================+================+================================+
| 回归系数的估计值 (Estimate)     | 反映了自变量对因变量的影响程度和方向：                                                                                                                                                                                                  | 理论合理值 | 与领域预期一致 | 与理论预期相反 | 若系数反直觉：                 |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 | -   `(Intercept)`（截距）                                                                                                                                                                                                               |            |                |                | -   检查多重共线性             |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 | -   `rm` （特征变量）的回归系数                                                                                                                                                                                                         |            |                |                | -   考虑变量转换               |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 |                                                                                                                                                                                                                                         |            |                |                | -   检查变量定义错误           |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 |                                                                                                                                                                                                                                         |            |                |                | -   可能存在交互效应           |
+---------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+----------------+----------------+--------------------------------+
| 回归系数的标准误差 (Std. Error) | **回归系数**的标准误差，表示回归系数估计的不确定性。                                                                                                                                                                                    | \<0.25     | \<0.1          | \>0.5          | 若标准误过大：                 |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 | 反映了回归模型拟合的d回归模型拟合的相对精度：标准误差较小说明系                                                                                                                                                                         |            |                |                | -   增加样本量                 |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 |                                                                                                                                                                                                                                         |            |                |                | -   处理异常值                 |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 |                                                                                                                                                                                                                                         |            |                |                | -   处理多重共线性             |
+---------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+----------------+----------------+--------------------------------+
| t值（t统计量）                  | **回归系数**的显著性（效应显著性）                                                                                                                                                                                                      | \>2或\<-2  | \>4或\<-4      | -2到2之间      | 若不显著：                     |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 | -   t统计量=对应回归系数/对应回归标准误差                                                                                                                                                                                               |            |                |                | -   删除或合并不显著的变量     |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 | -   **同样是比较不同模型的拟合能力，t统计量是针对每个回归系数的贡献来看不同模型的性能有没有改进，而F统计量是针对模型整体的性能看不同版的模型有没有得到改进。**                                                                          |            |                |                | -   考虑变量转换               |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 | -   回归系数显著不为0（通过t统计量的检验）可以表明如下可能：                                                                                                                                                                            |            |                |                |                                |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 |     1.  **假设检验结果**：从假设检验的角度看，这意味着我们拒绝了"该变量与因变量无关"的零假设。                                                                                                                                          |            |                |                |                                |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 |     2.  **变量关系确认**：表示各个自变量（预测变量）与因变量之间存在统计上显著的关系。这不是偶然的，而是数据中确实存在的模式。                                                                                                          |            |                |                |                                |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 |     3.  **预测贡献度**：某个变量对预测因变量有实际贡献——如果我们使用这个模型进行预测，包含这个变量几乎肯定会提高预测准确性。                                                                                                            |            |                |                |                                |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 |     4.  **效应存在**：在控制了其他变量后，这个特定变量对因变量有独立的影响。                                                                                                                                                            |            |                |                |                                |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 |     5.  **模型构建依据**：为模型中包含该变量提供了统计上的支持。在模型筛选过程中，我们通常会保留系数显著的变量：                                                                                                                        |            |                |                |                                |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 |     ```                                                                                                                                                                                                                                 |            |                |                |                                |
|                                 |     -   在多项式回归的特定情况下，如果高次项（如二次项、三次项）的系数显著不为0，则表明数据中存在非线性关系，简单的线性模型不足以准确描述变量之间的关系——**这支持了使用更复杂模型（包含高次项）的决定**                                 |            |                |                |                                |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 |     -   更进一步的，在三次多项式模型情形中，三次项系数显著不为0表明：**使用三次曲线比二次曲线更适合描述数据中的关系，证实了模型选择的合理性**                                                                                           |            |                |                |                                |
|                                 |     ```                                                                                                                                                                                                                                 |            |                |                |                                |
+---------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+----------------+----------------+--------------------------------+
| p值（假设几率）                 | 判断**回归系数**是否显著（统计显著性）：较小的p值（通常\<0.05）表示该变量对因变量有统计显著的影响：                                                                                                                                     | \<0.001    | 0.01＜p\<0.05  | \>0.05         | 若p值较大：                    |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 | -   **Pr(\>\|t\|)** 依赖于**残差自由度**，而不是回归自由度或总自由度。在回归模型中，**残差自由度** 是样本数 n 减去模型中估计的参数个数。对于一元回归模型（一个自变量），残差自由度是 n-2，其中2是因为模型中有两个参数（截距和回归系数） |            |                |                | -   重新评估变量选择或移除变量 |
|                                 | -   通常用于判断哪些变量应保留在模型中                                                                                                                                                                                                  |            |                |                |                                |
|                                 | -   和t统计值相比，其p值具备高解读价值                                                                                                                                                                                                  |            |                |                | -   变量转换                   |
|                                 |                                                                                                                                                                                                                                         |            |                |                |                                |
|                                 |                                                                                                                                                                                                                                         |            |                |                | -   考虑交互项                 |
+---------------------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------+----------------+----------------+--------------------------------+

**整体拟合度**

+-----------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------+------------------------------------------------+----------------------------------+
| 指标                                                      | 解释                                                                                                                                                                                                     | **理想值**                                                                                                                                | 优秀范围                                   | 需改进标准                                     | 改进建议                         |
+===========================================================+==========================================================================================================================================================================================================+===========================================================================================================================================+============================================+================================================+==================================+
| **残差的标准误差** （RSE，Residual standard error）       | **残差标准误差RSE，是整个模型所有观测对象（特征变量）产生的残差的平均水平：**                                                                                                                            | 尽可能小                                                                                                                                  | 相对因变量范围较小（因变量SD的30%以内）    | 相对因变量范围较大（\>因变量SD的50%）          | 若较大：                         |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                |                                  |
|                                                           | -   **是一个唯一值**                                                                                                                                                                                     |                                                                                                                                           |                                            |                                                | -   处理异常值                   |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                | -   尝试非线性变换               |
|                                                           | -   表示预测值与实际值之间的平均差异，即**回归模型的残差（实际值与预测值的差）在整体上的离散程度**——它可以理解为观测数据围绕回归线（或回归平面）的平均偏离程度的度量                                     |                                                                                                                                           |                                            |                                                | -   添加更多相关变量             |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                | -   考虑交互项                   |
|                                                           | -   反映了模型的预测精度：较小的残差标准误差通常意味着模型的预测效果较好                                                                                                                                 |                                                                                                                                           |                                            |                                                | -   探索不同函数形式             |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                |                                  |
|                                                           | -   残差标准误差和标准化残差是两个概念，注意辨别                                                                                                                                                         |                                                                                                                                           |                                            |                                                |                                  |
+-----------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------+------------------------------------------------+----------------------------------+
| R² (Multiple R-squared)                                   | R²衡量的是模型对数据变异的解释程度，即模型能够解释多少百分比的响应变量（因变量）的变化                                                                                                                   | 接近1                                                                                                                                     | -   单变量模型: \> 0.3                     | -   单变量模型: \< 0.3                         | 若较低：                         |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                |                                  |
|                                                           | -   反映了模型解释因变量变异的能力（拟合能力）                                                                                                                                                           |                                                                                                                                           | -   多变量模型: \> 0.6                     | -   多变量模型: \< 0.6                         | -   添加相关预测变量             |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                |                                  |
|                                                           | -   R²常用来衡量单个回归模型的效果，但它不适合比较不同复杂度（参数个数不同）的几个模型（尤其这几个模型可能预测的是同一个因变量）：因为增加更多参数通常会提高R²，即使这些额外的参数并没有提供真正的改进。 |                                                                                                                                           |                                            |                                                | -   探索交互项                   |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                |                                  |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                | -   探索非线性关系               |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                |                                  |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                | -   检查是否遗漏关键变量         |
+-----------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------+------------------------------------------------+----------------------------------+
| 调整R² (Adjusted R-squared)【多变量回归这个指标也很重要】 | 考虑变量数量的R²，反映了考虑复杂度（变量数量）的前提下的拟合度（拟合能力）                                                                                                                               | 接近R²                                                                                                                                    | 接近R²（与R²差距\<0.02）且随变量增加而增加 | 明显低于R²（与R²差距\>0.05）或随变量增加而减少 | 若远低于R²：                     |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                |                                  |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                | -   简化模型、移除不必要变量     |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                |                                  |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                | -   使用变量选择方法（降维……）   |
+-----------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------+------------------------------------------------+----------------------------------+
| F统计量 (F-statistic)                                     | 检验模型中自变量（预测因子）与因变量之间的关系是否显著，反映了模型整体拟合的显著性                                                                                                                       | 越大越好                                                                                                                                  | 高F值（\>10）且p值 \< 0.05                 | F值低（＜4）或p值 \> 0.05                      | 若较小：                         |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                |                                  |
|                                                           | -   原理：比较模型解释的数据变异分数和模型无法解释的数据变异分数的“大小”——即模型变异（可解释变异）和误差（残差：不可解释变异）的比值。                                                                   |                                                                                                                                           |                                            |                                                | -   重新考虑整个模型结构         |
|                                                           | -   用途：用于比较不同参数数量的模型（多元、多项……）                                                                                                                                                     |                                                                                                                                           |                                            |                                                |                                  |
|                                                           | -   如何比较：通过比较全模型（包含所有自变量）和简化模型（可能只包含部分自变量或没有自变量）来评估是否可以显著提高模型的拟合度                                                                           |                                                                                                                                           |                                            |                                                | -   检查数据质量                 |
|                                                           | -   解读：F统计量的值越大，表示模型的拟合效果越好，且自变量与因变量之间有显著的关系。F-统计量的值通常\> 6，表示拟合是有意义的。                                                                          |                                                                                                                                           |                                            |                                                |                                  |
+-----------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------+------------------------------------------------+----------------------------------+
| F统计量-p值                                               | 反映了F统计量的统计学显著性                                                                                                                                                                              | \<0.001                                                                                                                                   | \-                                         | \-                                             | 若不显著：完全重构模型           |
+-----------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------+------------------------------------------------+----------------------------------+
| F统计量-自由度 (DF)                                       | F统计量的值越大，表示模型的拟合效果越好，更说明自变量与因变量之间有显著的关系：F统计量的值接近1，意味着响应变量和预测因子之间没有关系；另一方面，如果值超过1，意味着它们之间有关联。                     | 样本充足——【一般以残差自由度衡量样本充足与否，因为有的时候模型涵盖的自变量（特征）太多了，p会很大，会对**整体自由度的分布**产生很大影响】 | n-p-1\>30                                  | n-p-1\<10                                      | 若较小：增加样本量或减少变量数量 |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                |                                  |
|                                                           | $F统计量=回归均方​/残差均方$                                                                                                                                                                              |                                                                                                                                           |                                            |                                                |                                  |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                |                                  |
|                                                           | 其中：                                                                                                                                                                                                   |                                                                                                                                           |                                            |                                                |                                  |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                |                                  |
|                                                           | -   回归均方，等于回归平方和（SSR）除以回归自由度 $DF_{model}$                                                                                                                                           |                                                                                                                                           |                                            |                                                |                                  |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                |                                  |
|                                                           | -   **残差均方RSE**，等于残差平方和（SSE）除以残差自由度 $DF_{residual}$​                                                                                                                                 |                                                                                                                                           |                                            |                                                |                                  |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                |                                  |
|                                                           | 所以F统计量的自由度包括：                                                                                                                                                                                |                                                                                                                                           |                                            |                                                |                                  |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                |                                  |
|                                                           | -   **回归自由度** $DF_{model}​$，通常是自变量的数量。                                                                                                                                                    |                                                                                                                                           |                                            |                                                |                                  |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                |                                  |
|                                                           | -   **残差自由度** $DF_{residual}​$，等于 $n - p - 1$（其中 n 是样本量 p 是自变量数量）。                                                                                                                 |                                                                                                                                           |                                            |                                                |                                  |
|                                                           |                                                                                                                                                                                                          |                                                                                                                                           |                                            |                                                |                                  |
|                                                           | 而Summary函数里面F统计量的那两个自由度对应的就是一个回归自由度（p，回归系数的个数/注意，截距不是回归系数），一个残差自由度（n-p-1，总自由度n-1减去p个自变量代表的自由度）。                              |                                                                                                                                           |                                            |                                                |                                  |
+-----------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------+------------------------------------------------+----------------------------------+

**[1]变量转换与非线性变换**

1.  变量转换（Variable Transformation） 变量转换是指通过应用数学变换（如对数、平方根等）对数据进行处理，目的是使数据更符合模型的假设，改善模型的性能，或者使数据更加符合正态分布等。例如，通过对数变换处理偏态分布的数据，或通过标准化处理变量尺度不一致的问题。数据处理阶段常用的独热编码就是一类特殊的变量转换。

2.  非线性变换（Nonlinear Transformation） 非线性变换是一类特殊的变量转换方法，它指的是对变量应用非线性函数进行转换，使得变量之间的关系不再是线性的。这意味着，非线性变换改变了原始变量的尺度或分布，使得变量之间的关系变得更加复杂或者更有助于某些模型（例如神经网络）拟合。常见的非线性变换包括对数变换、平方根变换、幂变换等。

关系：

-   变量转换包括线性和非线性变换，非线性变换是其中的一种类型。即所有非线性变换都是变量转换，但并不是所有变量转换都是非线性的。

-   非线性变换专注于应用非线性函数来改变变量的特性，这类变换通常用于调整数据的分布特性或减少模型复杂度。

举个例子：

-   变量转换：你可以通过对数据进行标准化处理，使数据范围从[0,1]，这属于线性变换。

-   非线性变换：通过对数据进行对数变换y=log(x)，这就属于非线性变换，常用于将右偏分布的数据转换为更对称的分布。

总结：

1、所有非线性变换都是变量转换的一部分，但变量转换也可以是线性的（例如标准化、归一化等）。

2、非线性变换通常用于改善数据的分布，或使得某些数据模式更加适合特定的模型（如神经网络）。

**[2]回归模型中的自由度**

自由度（Degree of Freedom,DF）的计算依赖于所使用的统计模型和数据的特点。通常，自由度是指在进行估计时可以自由变动的独立数据点的数量；自由度越大，通常意味着你有更多的样本或更多的参数来估计模型，模型效果也就越好。

对于回归模型，自由度可以从模型的参数数量和数据的样本数量来计算：

1.  **回归模型的总自由度**： 总自由度是样本数量 n 减去1，即n - 1（去看回归模型的推导，截距本质上就是回归原理模型中的基准平均值的变体）。它代表了样本数据的总变异。

    -   在计算数据总体的变异时，需要先估计一个整体平均值（即样本平均数）。一旦平均值被估计出来，这个均值就成为一个已知量，变异是围绕这个平均值来衡量的，因而有效地“牺牲”了 1 个自由度。

2.  **回归模型(回归系数)的回归自由度（模型自由度, DF\_{model}）**： 这是与模型中自变量（预测因子）的数量有关的自由度。它表示由回归模型解释的变异量的自由度。

    -   对于简单线性回归模型（只有一个自变量），回归自由度是 1

    -   对于多元回归模型（有多个自变量），回归自由度是自变量的数量

    $DF_{model} = \text{自变量的个数} = 1  (\text{对于一元回归模型})$

3.  **残差自由度（误差自由度, DF\_{residual}）**： 残差自由度是样本数 n 减去回归模型中**估计参数**个数——这是与模型的误差部分相关的自由度，表示剩余部分的变异量的自由度（**总共n个自由度，截距用于估算均值确定消灭了1个自由度，回归系数解释了变异量又消耗了1个自由度，最后到残差手上自由度就只有n-2了，而在一般的统计学样本中，这个n值往往大于30，这也解释了为什么哪怕是最简单的少样本模型，其拟合的误差依然很大，因为残差的自由度就是远大于“回归系数+截距=估计系数”的这部分理性确定的自由度，因此消灭残差是不可能的事情**）。

    -   对于回归模型，残差自由度是样本数 n 减去模型中的参数个数（包括回归系数和截距）

    -   对于简单线性回归，残差自由度是 n - 2（因为有两个参数：截距和回归系数）

    $DF_{residual} = n - \text{参数个数} = n - 2  (\text{对于一元回归模型})$

4.  **回归自由度和残差自由度之和等于总自由度**，即：

    $DF_{total} = DF_{model} + DF_{residual} = (n - 1)$

举个例子：

假设你有一个包含50个数据点的一元回归模型（n = 50）：

-   **总自由度（DF\_{total}）**：50 - 1 = 49

-   **回归自由度（DF\_{model}）**：1（因为只有一个自变量）

-   **残差自由度（DF\_{residual}）**：50 - 2 = 48

自由度是用来计算各种统计量的基础，并且它的计算方式取决于你要检验的统计模型和数据的结构。

###### 精简评估：回归系数&模型质量

在线性模型对象中获取信息需要一些数学和统计学方面的知识，Summary函数的指标过于全面，而初学者往往学习这些需要时间成本。为了快速上手，我们将学习评估线性模型的一些基本指标，作为平替：

**估计参数分析**

```{r}
summary(lm1)$coefficients
```

-   **Estimate**

    -   估计系数：截距(-34.671)和回归系数**斜率**(9.102)

-   **Std. Error**

    -   回归系数的标准误差：衡量估计回归系数的相对精度（或者是不确定性）。这个值越小越好，但是这个值和回归系数有关。根据经验，这个值至少要比估计系数小一个数量级——在我们的例子中，rm变量的标准偏差是0.42，它差不多是估计系数9.1的二十二分之一。

-   **t value**

    -   t统计量：衡量特征（自变量）的回归系数对模型的贡献（效应显著性）。这个值本身可能不具备什么解读的意义，但是你要知道**它用于计算假设几率和显著水平**：t统计量=对应回归系数/对应回归标准误差
    -   例如，t值为-13.08，指的是截距的估计值-34.671除以估计值的标准误差2.650得到的。

-   **Pr(\>\|t\|)**

    -   假设几率：表示**系数t值的双尾p值**，这个指标用于评估回归系数的统计显著性。

    -   **计算过程**：

        -   首先，对每个回归系数计算t统计量：t = (系数估计值)/(系数标准误)

        -   然后，基于给定的自由度（df），计算观察到的t值或更极端值的概率

        -   注意：**Pr(\>\|t\|)** 依赖于**残差自由度**，而不是回归自由度或总自由度。在回归模型中，**残差自由度** 是样本数 n 减去模型中估计的参数个数。对于一元回归模型（一个自变量），残差自由度是 n-2，其中2是因为模型中有两个参数（截距和回归系数）。

    -   **含义**：

        -   Pr(\>\|t\|) 表示"在原假设（系数为0）为真的情况下，观察到当前或更极端t值的概率"
        -   简单说，它回答了"如果该变量实际上对因变量没有影响，我们观察到这样的系数是否仅仅是由于随机偶然"

    -   **解读方法**：

        -   较小的p值（通常\<0.05）表示拒绝"系数为0"的原假设；即接收H1假设：该变量对因变量有统计显著的影响
        -   例如，在波士顿房价模型中，rm变量的Pr(\>\|t\|) \< 2e-16，表明房间数对房价有极其显著的影响

    -   **实际应用**：

        -   通常用于判断哪些变量应保留在模型中
        -   大多数研究中，p\<0.05被视为统计显著
        -   非常小的p值（如\<0.001）通常用"\*\*\*"标记，表示高度显著

**模型质量指标**

-   **残差(residuals)**：
    -   定义：预测/响应变量（因变量）实际值与预测值之间的差值
    -   理想值：对于大多数回归来说，你希望残差在画图时呈现正态分布——因为如果残差是正态分布的，意味着预测值和实际值之间的差异接近0，这正是我们需要的。
    -   注意：在线性模型中，residuals成分是一个数值向量，**它的长度与数据集中观测数目相同**。

```{r}
# 这个向量太长了，我们在这里只展示前20个残差
summary(lm1)$residuals[1:20]
```

-   **决定系数(R-squared)**：

    -   定义：R2等于预测因子（自变量）和响应变量（因变量）相关系数的平方总和（记得我们最开始说的，回归本质上可以看成相关关系的集合）

    -   标准：评估模型拟合好坏的标准，值在0-1之间，越高越好

    -   注意：决定系数高标志着相关性好，但相关性并不一定意味着因果关系

```{r}
summary(lm1)$r.squared
```

-   **残差的标准误差(RSE)**：
    -   定义：模型拟合产生的残差的标准差，这个值最好在数量上和残差成比例：对于正态分布来说，第一和第三分位数应该是+/-1.5 标准差。
    -   比较：在线性模型中，residuals成分是一个数值向量，**它的长度与数据集中观测数目相同，即每有一个预测值，其和实际值就会产生一个差异（残差）；而残差标准误差RSE，是整个模型所有观测对象（特征变量）产生的残差平均水平，是唯一值。**
    -   注意：当RSE刚好是0时，模型完美拟合数据，很也可能因为过拟合导致模型泛化能力较差。

```{r}
# RSE
summary(lm1)$sigma
```

-   **F统计量**：
    -   $F统计量=回归均方/残差均方$，其中：

        -   回归均方：等于回归平方和（SSR）除以回归自由度 $DF_{model}$

        -   **残差均方**：等于残差平方和（SSE）除以残差自由度 $DF_{residual}$​

        所以F统计量的自由度包括：

        -   **回归自由度** $DF_{model}$​，通常是自变量的数量p

        -   **残差自由度** $DF_{residual}$​，等于 n - p - 1（其中 n 是样本量 p 是自变量数量）

    -   内容：Summary函数里面，F统计量是长度为3的数值向量——包含F统计值、模型的回归系数自由度（本例中为1）和残差自由度（本例中为504）。而F统计量的那两个自由度对应的就是一个回归自由度（p，回归系数的个数/注意，截距不是回归系数），一个残差自由度（n-p-1，总自由度n-1减去p个自变量代表的自由度/注意，总自由度n-1减去的那个1实际上就是截距代表的1个自由度）

    -   F统计量和R2的联系区别：F统计量用于比较不同参数数量的模型，也能反映模型的拟合程度，但其更侧重于检验模型中自变量（预测因子）与因变量之间的关系是否显著。

        -   理论上说，模型的参数越多，拟合程度应该越好：因此R²侧重于衡量单个回归模型的效果，但它不适合比较不同复杂度（参数个数不同）的模型，因为增加更多参数总会提高R²，即使这些额外的参数并没有提供真正的改进。
        -   F统计量的值越大，表示模型的拟合效果越好，更说明自变量与因变量之间有显著的关系：F统计量的值接近1，意味着响应变量和预测因子之间没有关系；另一方面，如果值超过1，意味着它们之间有关联。
        -   在本例中，F统计值是472，所以我们可以推测medv（自变量）和rm（因变量）是关联的。
        -   总结：
            1.  **R²**关注模型对数据变化的解释能力，适用于衡量单个模型的拟合效果。
            2.  **F统计量**则用于检验模型中自变量和因变量之间的关联是否显著，尤其适用于比较不同参数数量的模型。

    -   F统计量与自由度（DF）的复杂关系：F统计量的值基于自由度计算而来，自由度影响F统计值，这是模型样本数（Case数量）和模型的参数数量（特征数量）的共同影响：

        -   参数p个越多，看似**回归均方**在分子上占得比重变大，那模型固然可能拟合得更好；
        -   但参数p个增加，n-p-1残差自由度就减少许多，那F统计量的计算公式的分母**残差均方**就会变大，F统计量反而会变小。
        -   因此，如果你增加的参数只是为了使模型更复杂，而这些参数没有实际的贡献，增加的参数可能不会显著提高模型的预测效果，尤其当F统计量的假定几率（Pr(＞\|t\|)）较高时。因为不能贡献的参数无法显著增加分子上的回归均方，但是其增加的p个自由度会显著改变模型内的自由度分布，增加分母上残差均方的影响，减小F统计量，反而不利于寻找特征变量和因变量之间的关系（**F统计量**本身就侧重于检验模型中自变量和因变量之间的关联是否显著）。

```{r}
# 在例子中，F统计值约为472，所以我们可以推测medv和rm是关联的：
summary(lm1)$fstatistic
```

#### (2)模型可视化

使用R的数据描点功能，我们可以用下面的命令将线性模型可视化：

使用attach()函数将Boston数据集放入R的搜索路径中，这样我们就不用在plot()和lines()函数中一直重复输入数据集的名称了。

```{r}
# 将 Boston 数据集加载到 R 环境中，并允许你直接引用数据集中的变量名，而不需要使用 Boston$variable 这种格式
attach(Boston)
# 两个连续变量，得到散点图
plot(rm, medv, pch=20, xlab="Avg. # Rooms", ylab="Median Value")
# 拟合出一条回归线：
  # 之前训练的线性回归模型lm1，它预测了medv（中位房价）与rm（每个房屋的平均房间数）之间的关系。
  # rm表示平均房间数、是自变量，而lm1$fitted是该模型的拟合值（fitted values）——拟合值是根据模型的估计系数（回归系数和截距）预测出来的因变量（在本例中是 medv）的值。
lines(rm, lm1$fitted, lwd=3)
```

#### (3)使用模型进行预测

现在你可以使用拟合出回归系数的训练模型、对新数据（不是来自Boston数据集的原始数据）进行预测。比方说，你想基于基于平均房间数——在这个例子中是6——预测这个平均房间数时、房屋价值的中位数。

##### 方法一：直接计算

在下面的代码中，使用coef(lm1)[1]获取第一个系数，然后把它与第二个系数coef(lm1)[2]乘以6相加。这里，我们看到预测的房屋价格中位数是\$19.942：

```{r}
coef(lm1)[1] + coef(lm1)[2]*6  # 预测平均房间数为6的房屋价值
```

##### 方法二：使用predict()函数

还有另一种方法来做预测：基于线性模型lm1使用predict()函数——我们需要把数据框作为一个参数传递，带上rm的值（=6）；我们得到了跟之前一样的预测房屋价格中位数。

```{r}
newdata <- data.frame(rm=6)
newdata
predict(lm1, newdata)
```

#### (4)模型诊断

以下是一些简单诊断方法的概述表格：

| 诊断检查 | 解释 | 理想情况 | 能否从Summary直接判断 | 优化建议 |
|----|----|----|----|----|
| 残差正态性 | 误差项是否服从正态分布 | 通过Shapiro-Wilk测试 (p\>0.05) | 无法从summary直接判断 | 绘制Q-Q图检查；进行Shapiro-Wilk测试 |
| 方差齐性 | 误差方差是否恒定 | 无趋势的残差图 | 无法从summary直接判断 | 绘制残差vs拟合值图；进行Breusch-Pagan测试 |
| 多重共线性 | 预测变量间的相关性 | VIF\<5 | 单变量模型不适用 | 增加变量后计算VIF |
| 影响点 | 异常且有高杠杆的观测 | Cook's距离\<4/n | 无法从summary直接判断 | 计算并绘制Cook's距离；检查高于阈值的观测 |

让我们看一些具体的诊断图，它们是线性模型和plot()函数结合提供的，如图所示：

在使用线性模型对象时，plot()提供了一套四个图表：残差-拟合值图、标准化残差的Q-Q图、比例尺定位图（标准化残差的平方根-拟合值）和残差-杠杆比例图（当 Cook's 距离超过某个阈值(如0.5或1)时，可以通过**附加数值(或标记点)的方法**来突出显示这些高影响点。这些附加值可以是不同大小或颜色的点，目的是使这些高影响点更加显眼，便于你注意到它们）的散点图：

```{r}
par(mfrow=c(2,2))
plot(lm1)
```

##### 1、证明方差齐性和验证线性假设：残差-拟合值图（Residuals vs Fitted）

-   该图展示了残差（观测值与拟合值的差）与拟合值之间的关系。对于落在（拟合）回归线上的点，其残差为0；因此在拟合-残差值图（Residuals vs Fitted）中的0线相当于原始散点图中的回归线。

-   **目的**：检测模型的**拟合情况**——如果数据点围绕0线随机分布（说明拟合带来的误差是完全随机的），没有明显的模式或趋势，说明模型拟合良好；如果点呈现某种模式（例如，曲线或群集），则可能表明模型不适合数据。

-   理想残差图的特征

    -   残差在0线（相当于模型拟合出的回归线）附近随机分布，表明线性关系假设合理

    -   残差形成一个大致水平的带状分布，表明误差方差相等（证明了方差齐性）

    -   没有明显"突出"的残差，表明无异常值存在

##### 2、证伪异方差性：比例尺定位图（Scale-Location）

-   该图绘制了标准化残差的平方根与拟合值之间的关系；这个图希望标准化处理之后的残差不要呈现出异方差性的特征，其实就是在从反面证明方差齐性。

-   **目的**：检查残差是否存在**异方差性**（即残差的变异程度是否随着拟合值的变化而变化）。理想情况下，不管预测值/拟合值如何变化，残差的平方根都应该均匀分布，没有明显的趋势。

##### 3、残差正态性：标准化残差的Q-Q（Normal Q-Q）图/正态百分位数图

-   该图检查标准化残差是否近似正态分布。残差在正态分布下应该呈现直线状。

-   **目的**：看是不是存在非正态残差，即判断回归残差是否符合正态分布的假设——如果点沿着对角线分布，则残差近似正态；如果偏离较大，可能意味着模型不符合正态性假设。

-   **残差不满足正态分布假设说明了什么？**

    如果残差不符合正态分布，可能意味着：1、模型缺乏有效性（可以改模型改不了数据）：未能捕捉到某些系统性模式，例如遗漏了重要的解释变量；2、模型结构和数据不匹配（既可以调整模型也可以调整数据）：模型的结构不适合数据的真实分布；3、数据本身的特性导致（既可以调整模型也可以调整数据，但优先考虑对数据做调整）：如非线性、异方差性、异常值等没有被考虑到……

    -   模型结构和数据不匹配/模型缺乏有效性

        1.  **模型规格不正确**

            -   **遗漏重要的解释变量**：如果模型中遗漏了一个或多个重要的自变量，残差可能会表现出系统性的模式。例如，残差可能与某些未被建模的因素相关，导致它们不符合正态分布。

            -   **错误的模型形式**：如果模型假设了一个错误的关系形式（如线性回归假设了变量之间是线性关系，但实际是非线性关系），那么残差可能无法呈现正态分布。这是因为数据本身的规律没有被准确捕捉，导致误差项（残差）呈现出某些结构性的偏差。

    -   数据本身的特性导致

        1.  **数据的非线性或非正态性**

            -   **非线性关系**：如果数据之间的关系本质上是非线性的，而模型却用了线性模型来拟合数据，残差就可能呈现出模式化的分布，偏离正态分布。例如，残差可能表现出尾部过重或歪斜的特征。

            -   **数据本身不是正态分布**：有些情况下，数据本身的分布就不是正态分布。即便残差是通过某种方式调整后计算出来的，它们仍可能没有呈现正态分布，特别是在极端值或异常值存在时。

        2.  **存在异常值或离群点（杠杆点）**

            -   **异常值**：数据中可能存在极端的异常值或离群点，这些极端值会严重影响残差的分布，使其偏离正态分布。这些异常值通常会使残差的尾部变重，甚至可能出现较大的歪斜，导致 Q-Q 图中的点偏离45°直线。

            -   **影响点/杠杆点**：某些数据点可能在预测中起到了过大作用，这些点对模型拟合产生了过多的影响，导致模型的残差出现偏差。

        3.  **误差的异方差性（Heteroscedasticity）**

            -   **异方差性**：如果模型的误差具有异方差性（即误差项的方差随自变量变化而变化），而不是均匀的常数方差，那么残差的分布可能就不再是正态的。标准的线性回归假设误差项具有常方差（即同方差性），如果这一假设不成立，残差可能呈现出明显的偏斜或重尾。

        4.  **样本量不足**

            -   **小样本问题**：在样本量较小的情况下，残差的分布可能偶然地偏离正态分布。样本量过小可能导致模型参数的不稳定，从而影响残差的分布。在这种情况下，随着样本量的增加，残差的分布可能会趋于正态。

        5.  **自相关性（Autocorrelation）**

            -   **自相关性**：**如果数据具有时间序列性质，残差可能会存在自相关，即残差之间存在依赖关系。**在这种情况下，残差的分布可能呈现出非正态的结构，导致 Q-Q 图中的点偏离直线。

##### 4、高杠杆点与/或异常值：标准化残差-杠杆值图（Residuals vs Leverage）

1.  标准化残差-杠杆值图展示了**标准化残差与杠杆值（Leverage）**之间的关系；其中，杠杆值（横坐标）衡量了一个观测点对拟合的影响程度，其反映了该点在自变量空间中的位置，**特别是距离（常用的距离指标是Cookie's距离指标）其他点较远的点具有较高的杠杆值**。杠杆值反映了数据点对拟合的影响，残差衡量了数据点拟合时的误差水平，因此，我们**基于杠杆值和残差值综合衡量**数据点对回归模型拟合的影响力，帮助识别需要深入检查的异常观测。

2.  **目的**：通过标准化残差-杠杆值图，你可以看到哪些数据点有较高的杠杆值（High Leverage），这些点可能是潜在的异常值或影响点——特别是当杠杆值较高且残差较大时，可能存在数据点对回归结果的强烈影响，这种点称为“高杠杆点”或“异常值”。通常，图中的**Cook's 距离线**（Cook’s Distance）作为一个基准线、被用来标记这些高杠杆点，Cook's距离线（R中通常是一个虚线）为0.5和1的值是识别影响点的常用基准值。

    -   什么是**Cook's距离**

        -   **Cook's距离（线）**是用来衡量单个观测点对回归模型整体拟合的总体影响的一个统计量，是一个综合度量：因为Cook's距离这一衡量指标，综合考虑了观测点的杠杆值（自变量值的影响力）和残差（回归模型预测值与实际值的差异）。

        -   **Cook's距离**的原理：如果移除某个数据点后，模型的拟合发生了显著变化，则说明该点对回归结果有较大影响——这些数据点往往有有很大的残差（**异常值**）和/或对拟合有远离对应的平均预测值的显著影响（**高杠杆值**），异常值（大残差）和高杠杆值（对拟合影响显著）综合作用得到较大的Cook's距离值，较大的Cook's距离值表示这个数据点可能会扭曲回归的结果和精度。

        -   **Cook's距离**的显示结果解读：较大的Cook's距离意味着该点可能对模型的拟合有较大影响，可能是一个**高杠杆点（对回归拟合的影响异常大）**或**异常值（残差异常大）**，有较大Cook's距离的点需要在分析过程中执行更深入的检查。

        -   Cook's距离的阈值（常用的一些经验标准如下）

            -   通常，当 Cook's距离大于1时，表示该点对模型有较大影响；但一般来说，值大于0.5就已足够引起警惕。

            -   **Cook's 距离 \> 0.5**：一般认为该点可能对模型有显著影响，需要进一步调查。

            -   **Cook's 距离 \> 1**：表示该点对模型拟合的影响非常大，通常被认为是一个**高影响点**，可能需要进一步的分析，甚至考虑是否要去除该点。

    -   Cook's距离的**高影响点**（异常值或高杠杆点）在残差-杠杆图的标注显示：当Cook's距离超过某个阈值（如0.5或1）时，在R的标准化残差-杠杆值图中，可以通过**附加数值(或标记特殊点)的方法**来突出显示这些高影响点——这些附加值可以是不同大小或颜色的点、目的是使这些**高影响点**更加显眼，便于你注意到它们。

    -   Cook's距离可视化

        -   下面的plot()函数可以使所有观测的Cook距离可视化：横轴表示数据点的位置索引（即第几个位置的数据点），纵轴表示其对应的Cook's距离（其距离很大，表示这个点是一个高影响点）

```{r}
par(mfrow=c(1,1))
plot(cooks.distance(lm1))
```

3.  总结：标准化残差-杠杆值图和Cookie's距离图的联系与区别

    -   **标准化残差-杠杆值图**是一个用来可视化潜在异常点或高杠杆点（异常点指残差异常大的数据点，高杠杆点指对模型整体拟合产生显著影响的点，这两类值合称高影响点）的工具，标出了高杠杆点和它们的残差——该图帮助我们发现高杠杆点和潜在的异常值。尽管在该图上，超出特定的Cook's距离会被标注为影响力较大的点，但这个图更多关注的是杠杆值和残差的关系，如果想具体看这个高影响点在数据集中的具体位置，Cook's距离图会更加的合适。

    -   **Cook's距离（图）**是一个综合的数值指标，用来量化每个数据点对回归模型拟合的影响力。它考虑了杠杆值和残差的综合影响，因此，Cook's距离的分析提供了一个更具体的标准以用于标记可能需要进一步调查的高影响点，但是这个高影响点是数据点的残差造成的还是数据点本身的高杠杆值造成的，还需要到残差-杠杆图中去进一步分析。

    -   综上，二者可以结合使用，以便更全面地评估数据中的潜在异常点或高杠杆点：**Cook's距离（图）**可以指出一些值得检查准确性的数据点，并告诉我们在数据集的哪些区域适合多获取一些数据点；而这个高影响点具体是如何产生的（高杠杆+高残差or高杠杆+一般残差or低杠杆+高残差……）可以到**标准化残差-杠杆值图**中去进一步查看。

##### 5、值得深入检查的点

我们还以波士顿房价模型的例子，展示我们在识别出高影响点后应该做的进一步分析有哪些：

```{r}
Boston[366,]  # mdev=27.5 rm=3.56
lm1$fitted[366]  
lm1$residuals[366]  
summary(lm1)$sigma  #RSE–residual standard error
lm1$residuals[366]/summary(lm1)$sigma 
```

1.  **展示第366条观测的内容**：

-   **mdev = 27.5**：表示第366条观测数据的因变量（`medv`）值为 27.5，这是目标变量（房价中位数）。

-   **rm = 3.56**：表示该观测数据的自变量（`rm`，即每个房屋的平均房间数）值为 3.56。

2.  **观测的拟合值和残差**：

-   **拟合值 = -2.258**：这是回归模型根据自变量（`rm`）预测出来的因变量值。也就是说，基于该模型，当 `rm = 3.56` 时，预测的 `medv` 值为 -2.258。显然，预测值与实际值之间有很大差距。

-   **残差 = 29.758**：残差是实际值与拟合值的差异，因此残差 = 实际值 - 拟合值，即 27.5−(−2.258)=29.758。这里残差非常大，表明这个数据点与模型的拟合结果差异很大，可能是一个异常点。

3.  **标准化残差的计算**：

-   **标准化残差**：标准化残差是各个数值点的残差除以回归模型残差的标准误差（RSE，Residual standard error）（$\hat{\sigma}$），用于衡量残差的大小相对于模型拟合中产生的残差标准误差。这可以帮助判断残差是否异常。

    -   什么是回归模型的标准化残差：标准化残差是将每个残差（$y_i - \hat{y}_i$）除以残差的标准误差RSE（$\hat{\sigma}$），得到的值。标准化残差是一个**相对度量**，用来衡量某个观测点的残差大小、相对于模型整体的残差标准误差RSE。

    -   什么是回归模型的残差标准误差RSE：在回归分析中，**回归模型的标准误差**（常称为“残差标准误差”或“模型标准误差”，在R中通常记为`sigma`）是回归模型残差的标准差，反映**回归模型的残差（实际值与预测值的差）在整体上的离散程度**。

        -   或者说，残差标准误差可以认为是观测数据围绕回归线（或回归平面）的平均偏离程度的度量，即模型拟合产生的误差在整体上的变异程度。

        -   **残差的标准误差RSE在数据诊断中的意义**

            1.  **衡量模型的整体拟合质量**

                -   残差标准误差越小，表示观测值与模型预测值之间的平均偏离越小，模型的拟合程度更好。

                -   这一指标可以帮助你快速评估模型预测的精度。

            2.  **用来计算回归系数的标准误差和 t 检验**

                -   **回归系数估计参数的标准误差与残差的标准误差直接相关**，进而影响系数显著性检验（t 检验）的结果。

                -   如果残差标准误差大，则回归系数的标准误也可能较大，系数的显著性就会降低。

            3.  **标准化残差**

                -   在诊断可疑点（异常值）或者衡量残差的相对大小时，我们常将残差除以残差标准误差得到“标准化残差”（studentized residual）。

                -   这样可以更公平地比较不同观测的残差，判断哪些点的偏离在模型标准误差的范畴内，哪些可能是异常值或高影响点。

            4.  **模型比较**

                -   在同一数据集上比较不同回归模型时，如果模型的残差标准误差显著降低，意味着新模型可能比旧模型拟合得更好。

-   **`summary(lm1)$sigma`**：这是从回归模型对象`lm1`中提取的回归模型的标准误差（$\hat{\sigma}$），是用于标准化残差计算的一个重要参数。

-   **标准化残差**的计算公式为：

    $\text{标准化残差} = \frac{\text{残差}}{\hat{\sigma}}$

4.  总结：

这段话的意思是，尽管第366条观测的残差非常大（29.758），但由于回归模型的残差标准误差可能也很大，计算出的标准化残差可能并不会太大。标准化残差帮助我们更准确地评估残差的异常性，通常，如果标准化残差超过 2 或 3，就可以视为异常点。然而，这条观测的标准化残差是相对较小的，因此它可能不是一个显著的异常点。

#### (5)残差分析与异常值处理

模型诊断很大程度上是为了识别高影响点，高杠杆值只是说明一个点对模型拟合的影响很大、并不是什么很重大的问题；而在线性回归分析中，残差（即实际观测值与模型预测值之间的差异）是评估模型质量和诊断问题的核心指标，异常值（残差异常大）的存在更是会影响模型的质量，需要重点关注——**残差分析**就是用来分析异常值的重要方法。

##### 1、残差的计算与可视化

残差可以通过`residuals()`函数从线性回归拟合中直接计算得出，基于此，拟合-残差图是一种常用的可视化方法，通常在x轴显示预测（拟合）值，y轴显示残差值。

```{r}
plot(predict(lm1), residuals(lm1))
```

除了上面直接提取拟合值和残差值绘图的方法，在R中，完成模型拟合后也可以使用`plot(lm1)`直接输出四张套图，其中就有残差-拟合值图。

注意：对于落在（拟合）回归线上的点，其残差为0；因此拟合-残差值图（Residuals vs Fitted）中的0线相当于原始散点图中的回归线。

##### 2、理想残差图的特征

一个"表现良好"的残差图应展现以下特征：

-   残差在0线（相当于模型拟合出的回归线）附近随机分布，表明线性关系假设合理

-   残差形成一个大致水平的带状分布，表明误差方差相等（证明了方差齐性）

-   没有明显"突出"的残差，表明无异常值存在

##### 3、异常值的识别与处理

###### 异常值识别

异常值是指那些实际响应值与模型预测值相差极大（大残差）的数据点。**它们在残差图上通常表现为明显偏离0线的点。**识别异常值有几种方法：

1.  **直观方法**：通过观察散点图和回归线（即看`plot(rm, medv)`）
2.  **残差分析**：通过检查残差图（`plot(lm1)`套图中的——方差齐性：残差-拟合值图（Residuals vs Fitted））
3.  **标准化残差**：将残差除以其标准差，使其更具可比性（`plot(lm1)`套图中的——高杠杆点与/或异常值：标准化残差-杠杆值图（Residuals vs Leverage）、残差正态性：标准化残差的Q-Q（Normal Q-Q）图/正态百分位数图、异方差性：比例尺定位图（Scale-Location））

###### 异常值处理的影响

当发现异常值后，研究者可能会考虑将其移除。这种做法的影响是多方面的：

1.  **对回归系数和回归线的影响**：通常较小，最小二乘法拟合相对稳健
2.  **对统计指标的影响**：显著影响标准化残差和R²值
    -   R²通常会提高，表明模型拟合度改善
    -   标准化残差分布（具体可见于**标准化残差的Q-Q（Normal Q-Q）图**）会变得更加正常

###### 处理异常值的建议

1.  **谨慎决策**：不应仅因数据点不符合预期就随意移除
2.  **考虑数据来源**：如果有理由相信异常值是由数据收集错误导致，可考虑移除
3.  **记录处理过程**：无论是否移除异常值，都应记录分析过程和决策依据

##### 4、残差分析对于异常值识别的适用范围与注意事项

残差分析不仅适用于一元线性回归，也适用于多元线性回归。然而，解释残差图有一定的主观性，特别是对于小样本数据集，不应过度解释每一个细微差别——例如，遇到较小的数据集时，不要在残差-拟合值（Residuals vs Fitted）图中倾注太多的注意力。有时候，数据集太小了，不值得花时间去解释残差-拟合值（Residuals vs Fitted）图。

#### (6)总结

线性回归是强大的预测工具，通过估计系数、残差分析和模型诊断，可评估模型质量并进行可靠预测；理解和正确解读各项统计指标对于构建有效模型至关重要。

### 2 多元线性回归

#### 概述：从一元到多元线性回归

多元线性回归是一元线性回归的扩展，用于处理含有多个预测因子（自变量）的现实问题：

-   一元线性回归的局限：一元线性回归仅基于单一特征变量做预测
-   多元线性回归的优势：多元线性回归能够处理多个预测因子
-   在本节中，我们仍然在一元线性回归的学习那样，使用最小二乘法作为损失函数来找到使得残差的平方和最小的回归系数（组合）——对应到R中，也就是将再次使用R中的lm()算法来找到多元的、最小二乘的、回归估计系数。

#### 概述：多元线性回归关注的核心问题

多元线性回归分析通常需要回答四个关键问题：

1.  响应变量和预测因子之间是否存在关系

2.  哪些是最重要的预测因子

3.  给定一组预测值（模型基于自变量值计算出的因变量估计值），应该预测哪些响应变量（因变量）？预测精度是多少？

4.  回归模型对数据的拟合程度有多好

#### (1)模型训练：多元线性回归分析——以Prestige数据集为例

##### 1. 数据准备

我们可以选取car包中的Prestige数据集，来进行多元线性回归的实操：先安装car包，然后加载库和Prestige数据集。

Prestige数据集是一个包含加拿大职业声望研究的数据集，收集了102种不同职业的相关信息。这个数据集主要目的是研究各种职业特征与社会声望之间的关系。数据集的主要特征包括：

-   职业声望得分(prestige)：基于社会调查得出的职业声望评分，是数据集的响应变量

-   教育水平(education)：从事该职业所需的平均教育年限

-   收入(income)：该职业的平均收入水平

-   女性比例(women)：该职业中女性从业者的百分比

-   职业类型(type)：职业的分类，如蓝领、白领、专业/管理等

-   人口普查代码(census)：用于职业分类的标准代码

可以利用这些变量进行多元线性回归分析，探索**哪些因素对职业声望有显著影响**，以及**这些因素的相对重要性（特征重要性图）**。

```{r}
# 安装并加载必要的包
# install.packages("car")
library(car)
data(Prestige)
```

##### 2. 探索性数据分析

在开始建模分析之前，使用summary()和head()函数来熟悉数据集。

```{r}
# 数据探索
summary(Prestige)
head(Prestige)
```

-   Summary函数数据解读

+------------------+-----------------------------------+------------------------+-------------------------------------------------------+
| 探索方向         | 观察指标                          | 潜在结论               | 量化判断标准                                          |
+==================+===================================+========================+=======================================================+
| **集中趋势**     | Mean（均值）、Median（中位数）    | 了解数据的中心位置     | 若Mean ≈ Median：数据可能呈对称分布                   |
|                  |                                   |                        |                                                       |
|                  |                                   |                        | 若Mean \> Median：数据可能右偏                        |
|                  |                                   |                        |                                                       |
|                  |                                   |                        | 若Mean \< Median：数据可能左偏                        |
+------------------+-----------------------------------+------------------------+-------------------------------------------------------+
| **数据分散程度** | Min、Max、四分位距（IQR = Q3-Q1） | 了解数据的变异性       | IQR/Median \> 0.5：变异性较大                         |
|                  |                                   |                        |                                                       |
|                  |                                   |                        | IQR/Median \< 0.3：变异性较小                         |
+------------------+-----------------------------------+------------------------+-------------------------------------------------------+
| **数据分布形状** | 四分位数与Min、Max的比较          | 了解数据的分布特征     | (Q3-Median)/(Median-Q1) \> 1.2：右偏                  |
|                  |                                   |                        |                                                       |
|                  |                                   |                        | (Q3-Median)/(Median-Q1) \< 0.8：左偏                  |
+------------------+-----------------------------------+------------------------+-------------------------------------------------------+
| **异常值检测**   | 使用1.5×IQR规则                   | 识别可能的异常值       | 若数据点 \< Q1-1.5×IQR 或 \> Q3+1.5×IQR：可能为异常值 |
+------------------+-----------------------------------+------------------------+-------------------------------------------------------+
| **类别分布**     | 类别计数                          | 了解类别变量的分布情况 | 标准差/均值 \> 0.5：类别分布不均衡                    |
+------------------+-----------------------------------+------------------------+-------------------------------------------------------+
| **缺失值分析**   | NA's计数                          | 了解数据完整性         | NA比例 \> 5%：需考虑缺失值处理策略                    |
+------------------+-----------------------------------+------------------------+-------------------------------------------------------+

-   Head函数数据解读

+------------------+----------------------------------------------------+------------------------------+--------------------------------+
| 解读维度         | 观察发现                                           | 潜在含义                     | 分析价值                       |
+==================+====================================================+==============================+================================+
| **数据类型识别** | education `<dbl>`                                  | 确认变量的数据类型和精度     | 指导后续数据处理方法的选择     |
|                  |                                                    |                              |                                |
|                  | income `<int>`                                     |                              |                                |
|                  |                                                    |                              |                                |
|                  | women `<dbl>`                                      |                              |                                |
|                  |                                                    |                              |                                |
|                  | prestige `<dbl>`                                   |                              |                                |
|                  |                                                    |                              |                                |
|                  | census `<int>`                                     |                              |                                |
|                  |                                                    |                              |                                |
|                  | type `<fctr>`                                      |                              |                                |
+------------------+----------------------------------------------------+------------------------------+--------------------------------+
| **职业特征**     | 所有显示职业均为专业类别(prof)                     | 专业职业普遍要求较高教育水平 | 揭示职业市场的分层与不平等现象 |
|                  |                                                    |                              |                                |
|                  | 教育水平范围：11.42-15.64年                        | 收入差异显著                 |                                |
|                  |                                                    |                              |                                |
|                  | 收入范围：8403-25879                               | 存在明显的性别不平衡         |                                |
|                  |                                                    |                              |                                |
|                  | 女性比例均较低：4.02%-15.70%                       |                              |                                |
+------------------+----------------------------------------------------+------------------------------+--------------------------------+
| **特殊样本识别** | 一般管理人员收入(25879)显著高于其他职业            | 可能存在薪资异常值           | 帮助识别需要特别关注的数据点   |
|                  |                                                    |                              |                                |
|                  | 物理学家教育水平最高(15.64年)                      | 专业技术职业教育要求较高     |                                |
+------------------+----------------------------------------------------+------------------------------+--------------------------------+
| **变量间关系**   | 教育水平较高的职业(物理学家、化学家)声望得分也较高 | 教育与声望可能正相关         | 提供变量间关联的初步线索       |
|                  |                                                    |                              |                                |
|                  | 收入最高的职业(一般管理人员)声望不是最高           | 收入与声望关系复杂           |                                |
+------------------+----------------------------------------------------+------------------------------+--------------------------------+
| **数据组织结构** | census数值有规律(1113-2113)                        | 数据可能采用特定编码系统     | 揭示数据集的组织架构           |
|                  |                                                    |                              |                                |
|                  | 可能按职业类别排序                                 | 存在内在的组织逻辑           |                                |
+------------------+----------------------------------------------------+------------------------------+--------------------------------+
| **数据质量**     | 前6行没有缺失值                                    | 数据收集相对完整             | 提供数据质量的初步评估         |
|                  |                                                    |                              |                                |
|                  | 数据在合理范围内                                   | 没有明显的输入错误           |                                |
+------------------+----------------------------------------------------+------------------------------+--------------------------------+
| **研究方向启示** | 职业间的教育回报差异                               | 人力资本投资回报不均衡       | 指导深入分析的重点方向         |
|                  |                                                    |                              |                                |
|                  | 专业职业的性别隔离                                 | 职业选择存在性别因素         |                                |
|                  |                                                    |                              |                                |
|                  | 声望与收入的非线性关系                             | 社会评价与经济回报不完全一致 |                                |
+------------------+----------------------------------------------------+------------------------------+--------------------------------+

##### 3. 划分训练集与预测集

###### 1、拆分数据为训练集与测试集

```{r}
# 处理缺失值并划分数据集：将无缺失值的数据集随机分为训练集(60%)和测试集(40%)，并设置随机种子以确保结果可重复


# 创建了一个新的数据框Prestige_noNA：通过使用na.omit()函数从原始的Prestige数据框中删除所有包含缺失值(NA)的行得到的
Prestige_noNA <- na.omit(Prestige)


# 行值将用于确定数据集（训练集和测试集）的大小：计算了Prestige_noNA数据框中的行数(即观测数量)，并将结果存储在变量n中
n <- nrow(Prestige_noNA)
# 计算训练集应该包含的观测数量：取总观测数的60%(0.6)，然后用round()函数将结果四舍五入为最接近的整数
ntrain <- round(n*0.6)


# 设置随机数生成器的种子为333：设置种子确保每次运行代码时得到相同的随机数序列，这样数据的随机拆分结果将是可重复的——这对于研究的可重复性和结果的一致性非常重要
set.seed(333)


# 从1到n的整数中随机抽取ntrain个数，并将这些随机选择的索引存储在变量tindex中：这些索引将用于从原始数据框中选择训练集的行。
tindex <- sample(n, ntrain)#sample()函数执行不放回的随机抽样

# 使用之前随机选择的索引tindex从Prestige_noNA数据框中提取行，创建训练数据集trainPrestige：方括号内的逗号表示我们要选择所有列。
trainPrestige <- Prestige_noNA[tindex,]

# 创建测试数据集testPrestige，它包含了Prestige_noNA中不在训练集中的所有行：方括号内的负号-tindex表示"选择所有不在tindex中的索引对应的行"。
testPrestige <- Prestige_noNA[-tindex,]
```

机器学习的核心步骤是将数据集分为训练集和测试集：

1.  **训练集(Training Set)**: 用于通过拟合回归系数来训练算法。

2.  **测试集(Test Set)**: 用于评估训练好的模型（泛化）性能，使用训练好的模型来预测（预测集里）已知的响应变量。

    -   常见的标准做法是将约60%的数据用于训练，40%用于测试

3.  **对测试集的进行泛化效果的评估**：在预测集中，将预测响应和观测到的（真实）响应作对比，看看它们之间有多接近——基于测试误差（测试集或者说预测集中的预测集残差）对各个数据点的差异进行衡量，然后可以选择返回对模型进行优化，然后重复这些过程。一旦得到满意的模型，你就可以用测试集的数据来看模型的**泛化**能力。

    -   **训练集&测试集的误差概念（理解两种不同类型的误差）**

        -   样本内误差（**In-sample error**）：

            -   也叫再代入误差（resubstitution error），指模型在训练集中的误差

            -   等同于训练集残差，即模型在用于构建模型的数据即中的预测误差（预测值和真实值的误差）

            -   通常用来评估模型的拟合程度

        -   样本外误差（**Out-of-sample error**）：

            -   也叫泛化误差，指模型在未用于训练的新数据上的误差

            -   等同于测试集（或预测集）残差，即模型应用到新数据时的预测误差

            -   通常用来评估模型的泛化能力

        -   总结：样本内误差通常小于样本外误差，因为模型可能会针对训练数据集中的噪声进行调整；因为在处理特定的训练数据集时，你的预测因子会针对这个训练集调整噪音；而在尝试一个新的数据集（测试集）时，噪音会变得不同，这会造成泛化应用中的精度下降(你就是拿这个训练数据进行拟合的嘛，那肯定拟合结果更接近用来训练的数据啊)。

    -   **训练集&测试集的误差对比**：在模型评估中，样本外误差通常更重要，因为它反映了模型在真实应用场景中的表现——如果样本内误差很小但样本外误差很大，这通常表明模型存在（训练集中）**过拟合**的问题。

###### 2、对训练集做一些快速的探索性数据分析

```{r}
# 绘制响应变量与各个预测因子之间的关系
plot(trainPrestige$prestige, trainPrestige$education)#展现趋势
plot(trainPrestige$prestige, trainPrestige$income)#无明显趋势
plot(trainPrestige$prestige, trainPrestige$women)#无明显趋势
```

如上，可以基于多个预测因子分别绘制其和响应变量的图表。例如，变量education和响应变量展现出一个线性趋势。

##### 4. 建立多元线性回归模型

在下面的代码中，我们基于拟合线性模型的函数lm()，使用trainPrestige来进行线性回归，用于拟合估计系数（回归系数+其他模型参数：截距……）。

注意：在lm()中使用的公式是prestige～.这种形式，这表示将除了因变量的其他所有变量都当做预测因子。

```{r}
# 使用所有自变量作为预测因子：
lm2 <- lm(prestige ~ ., data=trainPrestige)
# lm2：创建一个新变量 lm2 来存储线性回归模型的结果。
# lm()：是R中用于拟合线性模型的函数（Linear Model的缩写）。
  # prestige ~ . 是一个公式，表示：
    # prestige 是因变量/响应变量（我们要预测的对象）
    # ~ 符号分隔了公式的左右两边（读作"由...解释"）
    # .（点）是一个特殊符号，表示"使用数据集中的所有其他变量作为自变量/预测变量"。这意味着模型将使用 trainPrestige 中除了 prestige 以外的所有变量来预测 prestige。
  # data=trainPrestige 指定使用之前创建的训练数据集来拟合模型。
```

在"训练"阶段，模型从训练数据中学习变量之间的关系，以便之后可用于预测测试数据中的prestige值（因变量）。训练集中拟合出的`lm2`对象将包含线性回归模型的完整信息，包括：

-   估计的偏回归系数（每个自变量的权重）
-   拟合的其他估计参数（截距……）
-   残差（观测值与模型预测值的差异）
-   拟合统计量（如R²、F统计量等）
-   其他用于诊断和评估模型的信息

##### 5. 模型结果初步解读

summary()函数包含了每一个预测因子（自变量）的结果，就像一元线性回归案例中的一元预测因子一样的形式：

```{r}
summary(lm2)
```

注意：在R中使用`lm()`函数拟合线性回归模型后，输出的摘要结果（使用`summary(lm)`查看）通常会显示每个变量的系数估计值、标准误差、t值以及p值。根据p值的大小，系统会自动为估计（回归）系数旁边添加星号标记：

-   没有星号：p值 \> 0.05，表示不显著

-   `*`：p值 ≤ 0.05，表示在5%水平上显著

-   `**`：p值 ≤ 0.01，表示在1%水平上显著

-   `***`：p值 ≤ 0.001，表示在0.1%水平上非常显著

系数旁没有星号标记的变量（即p值大于0.05的变量）可以被认为是不显著的，可以考虑从模型中删除这些变量，因为它们对预测结果没有统计上显著的贡献：

-   这是基于统计假设检验中的置信度概念。p值代表了在原假设（该变量系数为零）为真的条件下，观察到当前或更极端结果的概率——较小的p值表明有足够证据拒绝原假设，认为该变量在模型中具有统计学意义。

-   在实际应用中，是否真的删除不显著的变量还需要考虑领域知识和模型的整体表现；有时出于理论原因，即使变量不显著也可能被保留在模型中。

在我们研究的模型中：

-   **education**和**income**对预测prestige有显著影响
-   其它变量如women、census和type影响不显著
-   模型的Adjusted R-squared为0.8222，表明模型解释了约82%的变异

#### (2)模型诊断：对训练集模型进行模型诊断

一旦得到一个拟合后的线性模型，你应该运行一些诊断图来完全理解结果：

```{r}
par(mfrow=c(2,2))
plot(lm2)
```

其实我觉得没必要自己绘制简单的这些分析图，因为plot函数直接输出的结果里面就包含这些图，而且plot函数附带的信息更加全面，更加便于我们进行模型诊断。

除非你希望基于下面的这些简单命令，配合绘图函数创造可以输出展示的解释性图表，才有必要自己去手搓。

##### 1. 拟合（预测）值-残差图（Residuals vs Fitted）——方差齐性和线性假设

我们可以手动绘制**拟合值（模型在训练集中的预测值）-残差（拟合模型后和实际值产生的差异）图**，用来确认**在0残差线（y轴上等于0的线）附近的分布情况**。

下图展示了一个“云”分布，证实了这个模型是正确的：

```{r}
plot(lm2$fitted, lm2$residuals)
```

1.  残差在0线（相当于模型拟合出的回归线）附近随机分布，说明拟合值-残差图中几乎没有模式，进而表明模型中没有非线性的成分：

    -   当线性模型正确捕捉了数据中所有的结构时，剩下的残差应该只包含随机误差。如果模型中缺少某种非线性关系，残差会保留这种结构化模式。

    -   当您看到残差随机散布在0线两侧，没有明显的模式（如曲线、U形或其他系统性趋势）时，这意味着您的线性模型已经捕捉了数据中的所有系统性变化；如果存在未被模型捕捉到的非线性关系，残差会显示出某种模式，表明线性模型漏掉了一些重要信息。

2.  残差形成一个大致水平的带状分布，表明误差方差相等（证明了方差齐性）：

    -   线性回归的一个重要假设是同方差性（homoscedasticity），即不同预测值水平的误差方差应该大致相同。

    -   当残差图显示一个均匀宽度的水平带状分布时，这表明无论预测值大小如何，误差的变异性都大致相同。如果带状分布呈现出"漏斗形"（如在一端宽在另一端窄），就表明存在异方差性（heteroscedasticity）——即误差方差随预测值变化，这违反了线性回归的基本假设。

    -   方差齐性对于确保参数估计的可靠性和统计推断的有效性非常重要，因为线性回归的标准错误计算假设误差项具有恒定方差。

3.  没有明显"突出"的残差，表明无异常值存在——如果你发现这个图中有一群明显的异常值，你可能需要探索一个或多个预测因子，才能解释这些异常值：

    -   异常值是与大多数数据点显著不同的观测值，**在多数语境中，异常值特指残差特别大的数据点**，在拟合值-残差图中表现为远离主要数据"云"的点。

    -   当拟合值-残差图没有明显的"突出"点时，这表明没有观测值产生特别大的误差。异常值在残差图中会显示为垂直方向上与大多数点明显分离的点。这些异常值可能代表：

        -   数据收集或记录错误

        -   特殊的案例或事件影响了这些观测值

        -   模型未能捕捉影响这些特定案例的重要因素

    -   如果存在异常值，它们可能对模型拟合产生不成比例的影响，使模型偏向于这些少数点，而不是代表大多数数据的一般模式。

##### 2. 残差值-索引图（有点类似于Cookie's距离图的概念）——寻找异常点

前面我们提到，Cook's距离是一个综合指标，它反映的是高影响点（高杠杆点(对模型拟合影响大的点)+异常点(残差的数值点)）在数据中的位置索引`Index`，即数据点对应在训练集或者说测试集的第几行。

```{r}
par(mfrow=c(1,1))
plot(cooks.distance(lm2))
```

和Cooki's距离相似的，诊断训练集的另一种常用技术是残差-索引图——索引指的是数据的行号，表明数据创建的特定顺序。和Cooki's距离图不一样的是，残差-索引图用于检查异常值点的出现是否有与索引相关的趋势，而Cooki's距离图是综合考虑残差（异常值）和对模型拟合的影响（杠杆点）的指标。总的来说，残差-索引图的作用如下：

-   用于检查是否存在与索引相关的（残差）趋势
-   （我们希望）**残差不应与观测顺序有关系**

我们可以用plot()命令来执行这个操作，下图展示的是没有趋势的情况：

```{r}
plot(lm2$residuals, pch=19)
```

残差与数据的顺序不应该有关系。如果残差在某些特定的行号（例如按时间顺序、年龄顺序等）上聚集成团或呈现出某种趋势，这可能意味着模型漏掉了一些重要的预测因子：

-   **残差图的期望**：残差图的目的是帮助我们检查模型是否合理。理想情况下，残差应该是随机分布的；也就是说，**残差不应依赖于输入数据的顺序**——如果模型已经很好地拟合了数据，那么我们不应该看到明显的模式或趋势。

-   **行号的趋势或异常值**：如果在某些行号上，残差出现明显的趋势或聚集成团，这通常是因为模型未能捕捉到某些变量的影响。比如，数据可能是按时间顺序排列的，而模型可能忽略了时间因素的影响。这时，残差在时间序列上的聚集可能是未考虑到时间变量的信号，表明模型需要改进。

-   **为什么不应该与顺序相关**：残差应该是“白噪声”——没有规律可言，代表模型已经捕捉到了数据中的所有系统性信息。如果残差的分布有明显的模式，那么它说明数据中的某些重要信息没有被模型捕捉到，可能是由于某些变量没有被纳入模型，或者是模型未能正确拟合这些变量的关系。

##### 3. 标准化残差Q-Q(分位数-分位数)图——证明（残差）正态分布假设

另一种诊断技术是使用qqnorm()和qqline()函数展示分位数-分位数（Q-Q）图，来确认**残差是否成正态分布**。

下图展示了残差是如何匹配正态分布的：Q-Q图将样本数据分布（在这个例子中，线性模型的残差）和理论分布（这里是一个正态分布）进行对比——如果残差分布方式跟正态分布一致，所有的点都将落在一条从左下到右上的45°直线上：

-   用于确认残差是否呈正态分布

-   线的系统偏差代表着违背正态分布，例如重尾或是歪斜

-   点落在45°直线附近表示残差近似正态分布

```{r}
rs <- residuals(lm2)
qqnorm(rs)
qqline(rs)
```

###### 如何理解QQ图的原理和正确解读QQ图

1.  **正态分布的假设**：很多统计模型（如线性回归）在建立时假设残差服从正态分布。如果残差不服从正态分布，可能影响模型估计的有效性和后续的推断过程。Q-Q 图通过直观展示残差的分布，帮助我们验证这个假设。

2.  **Q-Q 图的作用**：Q-Q 图（Quantile-Quantile plot）是用来比较两个概率分布的一种图形工具——它将样本数据的分位数与理论分布的分位数进行比较。Q-Q 图中的每个点表示样本数据分位数与理论分布分位数之间的关系；如果样本数据的分布与理论分布一致，这些点应该大致落在一条直线上。

    -   在本例中，我们将样本数据的残差（即线性回归模型的误差项）与理论正态分布进行对比：如果残差是正态分布的，Q-Q 图中的点应该落在一条45°的直线上。

3.  **为什么45°直线是残差理论分布分位数的表征线**：如果残差的分布完全符合正态分布，那么残差的分位数应该与标准正态分布的分位数严格对应。在这种情况下，Q-Q 图中的点就会落在一条从左下到右上的45°直线——这个45°直线代表了标准正态分布的分位数与样本数据分位数完全一致。

4.  **偏离45°直线的解读**：

    -   **偏离直线**：如果 Q-Q 图中的点明显偏离直线，说明样本数据的分布与理论正态分布不一致。常见的偏离模式包括：

        -   **重尾**（heavy tails）：如果点在图的两端（即分位数的极值部分）偏离直线，表示样本数据的尾部比正态分布的尾部更重，说明数据可能有极端值或异常值，残差的分布可能存在较强的离群点。

        -   **歪斜**（skewness）：如果点在图的一侧偏离直线（例如，向上或向下偏移），说明样本数据的分布偏离了正态分布，可能是分布不对称，即数据的分布存在偏斜。

    -   **无偏差**：如果点完全落在45°直线附近，则说明残差的分布接近正态分布。

5.  **残差不满足正态分布假设说明了什么？**

如果残差不符合正态分布，可能意味着：1、模型缺乏有效性（可以改模型改不了数据）：未能捕捉到某些系统性模式，例如遗漏了重要的解释变量；2、模型结构和数据不匹配（既可以调整模型也可以调整数据）：模型的结构不适合数据的真实分布；3、数据本身的特性导致（既可以调整模型也可以调整数据，但优先考虑对数据做调整）：如非线性、异方差性、异常值等没有被考虑到……

-   模型结构和数据不匹配/模型缺乏有效性

    -   **模型规格不正确**

        -   **遗漏重要的解释变量**：如果模型中遗漏了一个或多个重要的自变量，残差可能会表现出系统性的模式。例如，残差可能与某些未被建模的因素相关，导致它们不符合正态分布。

        -   **错误的模型形式**：如果模型假设了一个错误的关系形式（如线性回归假设了变量之间是线性关系，但实际是非线性关系），那么残差可能无法呈现正态分布。这是因为数据本身的规律没有被准确捕捉，导致误差项（残差）呈现出某些结构性的偏差。

-   数据本身的特性导致

    -   **数据的非线性或非正态性**

        -   **非线性关系**：如果数据之间的关系本质上是非线性的，而模型却用了线性模型来拟合数据，残差就可能呈现出模式化的分布，偏离正态分布。例如，残差可能表现出尾部过重或歪斜的特征。

        -   **数据本身不是正态分布**：有些情况下，数据本身的分布就不是正态分布。即便残差是通过某种方式调整后计算出来的，它们仍可能没有呈现正态分布，特别是在极端值或异常值存在时。

    -   **存在异常值或离群点（杠杆点）**

        -   **异常值**：数据中可能存在极端的异常值或离群点，这些极端值会严重影响残差的分布，使其偏离正态分布。这些异常值通常会使残差的尾部变重，甚至可能出现较大的歪斜，导致 Q-Q 图中的点偏离45°直线。

        -   **影响点/杠杆点**：某些数据点可能在预测中起到了过大作用，这些点对模型拟合产生了过多的影响，导致模型的残差出现偏差。

    -   **误差的异方差性（Heteroscedasticity）**

        -   **异方差性**：如果模型的误差具有异方差性（即误差项的方差随自变量变化而变化），而不是均匀的常数方差，那么残差的分布可能就不再是正态的。标准的线性回归假设误差项具有常方差（即同方差性），如果这一假设不成立，残差可能呈现出明显的偏斜或重尾。

    -   **样本量不足**

        -   **小样本问题**：在样本量较小的情况下，残差的分布可能偶然地偏离正态分布。样本量过小可能导致模型参数的不稳定，从而影响残差的分布。在这种情况下，随着样本量的增加，残差的分布可能会趋于正态。

-   **自相关性（Autocorrelation）**

    -   **自相关性**：**如果数据具有时间序列性质，残差可能会存在自相关，即残差之间存在依赖关系。**在这种情况下，残差的分布可能呈现出非正态的结构，导致 Q-Q 图中的点偏离直线。

#### (3)模型评估：测试集中进行模型评估

##### 1. 在测试集上的预测

基于`testPrestige`测试集的数据来泛化训练集得到的模型的，使用训练集模型+测试集预测因子（自变量）来预测响应变量`prestige`（它的真实值是已知的）。我们的想法是预测一些已知结果的响应变量（测试集中的因变量）来确定测试误差，这样当你使用响应变量未知的新数据时，预测会更精确。

```{r}
predict2 <- predict(lm2, newdata=testPrestige)
```

##### 2. 预测准确性评估

为了看我们对测试集的预测有多准确，可以使用 `cor()` 函数来计算预测值和实际值之间的统计相关性（通常是皮尔逊相关系数），在这个例子中，计算得到的相关系数是 0.915。因为这个值非常接近 1，表示prestige的预测值与实际值之间有很强的正线性相关性。

所以可以推断，这两个变量是高度相关的，模型的预测结果相对准确。

```{r}
cor(predict2, testPrestige$prestige)
# 结果为0.915，接近1，表明预测值与实际值高度线性相关
```

###### 如何理解相关性函数对模型预测效果的解读

1.  **皮尔逊相关系数的意义**：皮尔逊相关系数（`cor()` 函数计算的就是这个系数）是衡量两个变量之间线性关系强度的统计量，值的范围从 -1 到 +1：

    -   **+1** 表示完全正相关，意味着一个变量的变化完全可以通过另一个变量的变化来预测

    -   **-1** 表示完全负相关，即一个变量增加时另一个变量减少，且变化完全对应

    -   **0** 表示没有线性关系，两个变量之间没有任何线性相关性

    在本例中，相关系数是 0.915，接近于 +1。这意味着预测值和实际值之间有非常强的正线性关系。也就是说，预测值和实际值几乎是成比例变化的。这样高的相关系数表明模型的预测非常准确，至少在整体趋势上与实际值高度一致。

2.  **为什么这个值接近 1 就意味着成线性相关**：皮尔逊相关系数的接近 1 表明变量之间有强烈的线性依赖关系——这个数值接近 1，说明通过（线性）模型的预测值，可以非常准确地反映实际值的变化趋势。反之，如果相关系数很低或为 0，说明模型的预测与实际数据之间没有线性关系，模型的预测效果差。

##### 3. 模型评估/后期评估：实际值-预测值图

作为一种后期检查，我们使用的最后一种诊断多元线性回归模型的方法是用模型中未使用的变量生成一张图表：在下面的代码中，生成如下图所示。

```{r}
# testPrestige$prestige:这是数据框testPrestige中prestige列的值，作为横轴（x轴）数据
# predict2: 这是预测值或模型的输出，作为纵轴（y轴）数据
# pch=c(testPrestige$type): pch用于设置散点图中点的形状，testPrestige$type是数据框中的一列，它表示不同的类别（例如“bc”、“prof”和“wc”）——这些类别的不同值会影响散点的标记类型。
plot(testPrestige$prestige, 
     predict2, 
     pch=c(testPrestige$type))

# legend(): 该函数用于在图表中添加图例。它为不同的点类型和类别添加标签。
  # 'topleft': 图例的位置，在图形的左上角。
  # legend=c("bc", "prof", "wc"):这指定了图例中的标签，分别表示三个类别："bc"、"prof" 和 "wc"。
  # pch=c(1,2,3): 设置图例中每个标签对应的点的形状。这里的 1、2和3分别对应于散点图中三种不同类型的标记（可以理解为圆圈、三角形、方形等，具体取决于R中的默认设置）。
  # bty='o': 这个参数控制图例框的边框类型。'o'表示有边框。
legend('topleft', 
       legend=c("bc", "prof", "wc"), 
       pch=c(1,2,3), 
       bty='o')
```

我们绘制了测试集中变量prestige的实际值-预测值图：理想状态下，我们希望看到一条45°的直线，prestige实际值与我们预测的完全相等（虽然通常情况下都不是这样的）。

在测试集中，你可以尝试鉴定一些之前忽略的潜在未捕获趋势，因此我们尝试在图中加入了一个新的变量，也就是type——在本例中，type是一个分类变量，表示职业的类型，它有以下几种可能的值：bc、prof和wc。

#### (4)残差分析的在回归中的重要性

残差分析是机器学习关键部分；通过认真观察，残差可以告诉我们关于模型的一些残差假设（正态假设、方差齐性、线性假设……）是否证实，选择的模型是否是合适的：

1.  残差是模型拟合、预测中误差的估计（预测响应-观测响应=残差），可以理解为不能通过拟合模型解释的随机误差；其应该是完全随机的，因此我们希望其没有任何模式、规律地分布在0残差线周围。
2.  从各个回归模型的残差假设的角度出发：我们希望残差（大概地）成正态分布（正态假设），并（近似地）成均值为0、方差恒定（方差齐性）的独立分布。

### 3 多项式回归

#### 概述：多项式回归的基本概念与数学原理

多项式回归是一种拓展线性回归的监督学习方法，通过添加原始预测因子的高次项来处理响应变量与预测因子之间的非线性关系；特别适用于散点图显示非线性模式的情况——如果是这种情况，多项式回归可以用于探索**不同曲度等级下的预测因子**（自变量）。

1.  通过提升原始预测因子的幂次来获取额外的预测能力，可以处理数据中的曲线关系（非线性关系）。

    -   多项式回归的原理：**将单个预测变量X扩展为多个变量X、X²、X³等，即使用一个预测变量X的多次方（X, X², X³...）作为预测因子。**例如：

        -   一次多项式：就是标准线性回归 (线性关系：直线)：（Y = β₀ + β₁X）

        -   二次多项式：包含X和X²项 (二次曲线：抛物线)：（Y = β₀ + β₁X + β₂X²）

        -   三次多项式：包含X、X²和X³项 (三次曲线：S形曲线)：（Y = β₀ + β₁X + β₂X² + β₃X³）

2.  以分层方式使用，逐步增加模型的复杂度，进而找到最能代表数据集的模型。

3.  对于足够高的（幂）次数，可以生成极端的非线性曲线；但次数通常不超过3-4次，过高可能导致过拟合（在测试集中泛化能力不佳）。

    -   理论上，可以通过提升多项式次数来获得更精确的模型，但过高次数可能导致过拟合，使用超过三次或四次的多项式比较罕见——**因为高次多项式会生成过于灵活的曲线，呈现奇怪形状，可能过度拟合训练数据**。

#### 概述：在R中实现多项式回归

在R中可以通过以下两种方法实现多项式回归：

##### 1. 使用`poly()`函数

###### 1、函数结构

```{r}
fit_d2 <- lm(nox ~ poly(dis, 2, raw=TRUE), data=Boston)
```

`lm(y ~ poly(x, n, raw=TRUE))` - `x`表示预测因子（名称） - `n`表示多项式的次数 - `raw=TRUE`表示使用原始的非正交多项式

###### 2、工作原理

a.  基本原理

    -   多项式回归的本质是在线性模型中加入非线性项（原始变量的高次幂）。例如，对于一个简单的线性模型：$y = β₀ + β₁x$

    -   我们可以扩展为多项式模型：$y = β₀ + β₁x + β₂x² + β₃x³ + ... + βₙxⁿ$

    -   `poly()` 函数的作用就是**帮助我们从原始的x变量生成这些高次项（x², x³等）**，使我们能**在线性模型框架内实现非线性拟合**。

b.  `poly()`函数的两种工作模式（通过`raw`参数控制）

-   原始多项式 (raw=TRUE)

    -   第1列: x（一次项）

    -   第2列: x²（二次项）

    -   第3列: x³（三次项）

当设置`raw=TRUE`时，`poly()`直接计算原始变量的幂：

```{r}
poly(x, 3, raw=TRUE)
```

这种方式直观易懂，但在数值上可能导致共线性问题，特别是当x的值较大或多项式次数较高时。

-   正交多项式 (raw=FALSE，默认)
    -   这时生成的多项式在数学上是正交的，意味着它们之间没有线性相关性。这解决了原始多项式可能带来的数值问题，并提高了计算稳定性。
    -   正交多项式的生成基于一系列复杂的数学变换，本质上是对原始多项式进行线性组合，使得每个生成的多项式都与其他多项式正交。

当默认使用`raw=FALSE`时，`poly()`会生成正交多项式：

```{r}
poly(x, 3)  # 默认raw=FALSE
```

c.  多项式回归的实现机制

当我们运行以下代码时：

```{r}
model <- lm(y ~ poly(x, 3, raw=TRUE), data=df)
```

-   poly函数运行：

    -   **输入**: 原始变量(x)和所需多项式次数(n=3)

    -   **输出**: 包含从1次到n次幂的矩阵，每列对应一个幂次（一次列、二次列……n次列），每行对应一个观测值（个案）：在本例中，因为是二次项回归，因此有x1、x2两列，1-506个观测值占据506行

-   poly函数的矩阵作为预测变量传递给`lm()`函数

-   `lm()`函数使用这些预测变量拟合模型，估计回归系数

-   结果是一个包含截距和2个多项式系数的模型

d.  为什么使用poly()而不是手动计算幂

    1.  **数值稳定性**：当使用正交多项式时，可以避免预测变量之间的高度相关性，提高计算精度

    2.  **便捷性**：生成高次项更简洁，特别是当次数较高时

    3.  **灵活性**：可以选择原始多项式或正交多项式

    4.  **与R的公式接口兼容**：直接与`lm()`函数等集成

e.  总结

`poly()`函数通过生成原始变量的高次项矩阵，使我们能够使用线性回归的框架处理非线性关系。这种方法的优势在于可以**保持线性模型的简单性和可解释性，同时捕捉数据中的非线性模式**。

##### 2. 使用`I()`包装函数

###### 1、函数结构

```{r}
fit_d2 <- lm(nox ~ dis + I(dis^2), data=Boston)
```

`lm(y ~ x + I(x^2) + I(x^3))`

-   `I()`函数是必要的，因为公式中使用的插入符号`^`没有常规的数学意义（即自乘）

-   `I()`函数用于确保插入符号`^`被正确解释为幂运算

###### 2、工作原理

a.  核心功能

`I()` 函数在R语言中是一个"恒等"或"按原样处理"函数，主要用于保护公式中的表达式不被公式语法特殊解析。

b.  工作机制

-   公式语法中，符号如 `+`, `-`, `*`, `^`, `:` 具有特殊含义

-   `I()` 函数将括号内的表达式标记为"要按照普通数学表达式处理"

-   当表达式被计算后，结果被视为公式中的单一项

c.  实际应用

    -   **多项式项**: `I(x^2)` 表示"x的平方"而非公式语法中的交互项

    -   **算术运算**: `I(x+y)` 表示"x加y"而非"包含x和y两个变量"

    -   **函数转换**: `I(log(x))` 应用对数转换

    -   **逻辑运算**: `I(x > 10)` 创建二值预测变量

d.  在多项式回归中

```{r}
lm(y ~ x + I(x^2) + I(x^3), data=df)
```

这里，`I()`确保`x^2`和`x^3`被解释为x的平方和立方，而不是公式语法中的其他含义。

5.  本质作用

`I()` 函数在公式语义和数学计算语义之间架起了一座桥梁，使我们能够在R的统计模型公式中嵌入复杂的数学表达式，从而构建更灵活的模型。

#### (1)模型训练：多项式回归——以Boston数据集为例

我们使用Boston数据集作为案例：

先检查的散点图，图中包含了两个变量：nox（因变量）和dis（自变量），在两个变量组成的散点图中、其关系不是线性的——当dis值介于6和12之间时，对应的nox值相对平缓；然而，当dis值小于6时，nox呈现出非线性变化。这些特征说明数据是曲线型的。

```{r}
library(MASS)
data(Boston)
names(Boston) 
```

接下来基于Boston数据集，我们分别使用dis的一次、二次、三次多项式来预测nox，以挖掘多项式回归逐步提升的潜力。以Boston数据集中nox(氮氧化物浓度)和dis(到就业中心的加权距离)之间的关系为例：

##### 1. 一次多项式(线性)拟合

先用lm()函数来拟合一个线性模型——一次多项式就是一元线性回归，回归曲线图是一条直线。

```{r}
# lm()函数用于拟合线性模型
fit_d1 <- lm(nox~dis, data=Boston)

# 查看拟合出的模型所有组件名称
names(fit_d1)

# 查看模型的统计摘要以评估拟合质量
  # 一次多项式（一元线性）回归后的R²: 0.5909
summary(fit_d1)

# 绘制真实的dis-nox散点图和基于dis预测因子拟合出的线性回归线，以直观地评估模型是否适合这些数据
plot(Boston$dis, Boston$nox)
  # 创建一个散点图，x轴是dis(距离)，y轴是nox(氮氧化物浓度)
  # 这个图可以直观地展示两个变量之间的关系
  # 这一步骤有助于识别潜在的非线性关系
lines(Boston$dis, fit_d1$fitted, col=2, lwd=3)
  # 在散点图上添加回归线：
    # 第一个参数 Boston$dis 是x轴的值
    # 第二个参数fit_d1$fitted是y轴的值（模型预测的nox值）:其中，fit_d1$fitted中的fitted是线性回归模型对象中的一个组件，它代表模型拟合后得到的预测值y值（也称为拟合值）
  # col=2设置线的颜色为红色（在R中，2代表红色）
  # lwd=3设置线的宽度为3（比默认宽度粗）
  # 这条线可以直观地展示线性回归模型是如何拟合数据的
```

如上图，nox和dis之间存在显著的关系，但是这个关系看起来显然是非线性的，数据本身（散点）显示出曲线关系。

###### 重要补充：拟合的线性回归模型对象中的组件

线性回归模型对象（在R中通过`lm()`函数创建）包含许多有用的组件。以下是查询和使用这些组件的方法：

a.  查看模型对象的所有组件

```{r}
# 创建模型
model <- lm(nox~dis, data=Boston)

# 查看所有组件名称
names(model)
```

b.  常用组件及其用途

<!-- -->

1.  **估计系数**

```{r}
model$coefficients  # 或简写为 coef(model)
```

返回模型的截距和斜率（回归系数）

2.  **拟合值**

```{r}
model$fitted.values  # 或简写为 model$fitted 或 fitted(model)
```

返回模型预测的y值

3.  **残差**

```{r}
model$residuals  # 或 resid(model)
```

实际y值减去预测y值的差

4.  **标准化残差**

```{r}
rstandard(model)
```

标准化后的残差，用于诊断

5.  **杠杆值**

```{r}
model$hat  # 或 hatvalues(model)
```

衡量观测值对模型的影响程度

6.  **Cook's距离（基于残差+杠杆值的综合评估）**

```{r}
cooks.distance(model)
```

衡量单个观测值的影响力

7.  **模型矩阵**

```{r}
model$model  # 或 model.matrix(model)
```

用于拟合模型的数据

8.  **调用**

```{r}
model$call
```

创建模型时使用的函数调用

9.  **自由度**

```{r}
model$df.residual#残差自由度
```

10. **方差-协方差矩阵**

```{r}
vcov(model)
```

系数的方差-协方差矩阵

c.  获取模型信息的函数

<!-- -->

1.  **模型摘要**

```{r}
summary(model)
```

提供全面的统计摘要，包括R²、F统计量等

2.  **方差分析表**

```{r}
anova(model)
```

提供方差分析结果

3.  **估计系数的置信区间**

```{r}
confint(model)
```

计算系数的置信区间

4.  **预测函数**

```{r}
predict(model, newdata=data.frame(dis=c(4, 5, 6)))
```

用模型预测新的数据点

5.  **影响力测量**

```{r}
influence.measures(model)
```

计算多种影响力统计量

d.  实际例子

```{r}
# 创建模型
fit <- lm(nox~dis, data=Boston)

# 基本组件
coef(fit)           # 查看系数
fitted(fit)         # 查看拟合值
resid(fit)          # 查看残差

# 模型诊断
plot(fit)           # 生成模型诊断图
hist(resid(fit))    # 残差直方图

# 预测
new_data <- data.frame(dis=c(2, 4, 6))
predict(fit, newdata=new_data)
```

这些组件和函数让你可以全面分析和利用回归模型的结果，进行模型诊断和预测。

##### 2. 二次多项式拟合

对于更高次数的回归方程式，我们将使用`poly()`函数来提升`dis`的幂次数——使用`poly(dis,2,raw=TRUE)`生成了一个506行×2列的矩阵，用于二次多项式回归。这个矩阵的结构如下：

1.  **行数**: 506行，对应Boston数据集中的506个观测值。

2.  **列数**: 2列，分别对应：

-   第一列: dis（一次项）

-   第二列: dis²（二次项）

当用于回归时，这个矩阵被用作预测变量，允许模型同时考虑线性项和二次项。参数`raw=TRUE`表示使用原始的非正交多项式。

另一种创造多项式基函数的方法是上面提到的R中的`I()`包装函数。不论哪种情况，我们都创造了一个非线性拟合；熟悉的非线性二次型曲线如下图所示：

```{r}
# 拟合二次模型
fit_d2 <- lm(nox ~ poly(dis, 2, raw=TRUE), data=Boston)

# 调整后的R²: 0.6987
summary(fit_d2)

# 绘制原始数据的散点图，查看其分布模式
plot(Boston$dis, Boston$nox)

# 为什么这里要排序？
# 在代码‘lines(sort(Boston$dis), fit_d2$fitted.values[order(Boston$dis)], col=2, lwd=3)’中，我们看到对 Boston$dis 进行了排序，同时也按照相同的顺序重排了拟合值。
# 为什么？
  # 1、lines()函数的连接方式:lines()函数按照点在数据中出现的顺序依次连接。它不会自动将点按x值从小到大排序后再连线。

  # 2、无序数据的问题：如果原始数据（Boston$dis）不是按照从小到大排序的，那么绘制的线条会根据数据在数据框中的原始顺序连接点，而不是按照 x 轴从左到右的顺序。

  # 3、交叉线而非平滑曲线：对于非线性关系（如二次曲线），如果点不按x值排序，线条会来回交叉，看起来像一个杂乱的折线图，而不是我们期望的平滑曲线。
lines(sort(Boston$dis), 
      fit_d2$fitted.values[order(Boston$dis)],  
      col = 2, 
      lwd = 3)
```

注意：二次项拟合比只有线性项的拟合效果好一点。同时也要注意，二次拟合的R^2^值为0.6999，作为对比，线性拟合的R^2^值为0.5917，提升并不是很大。

##### 3. 三次多项式拟合

现在用三次多项式拟合线性模型。

如上面所说，一图胜千言，基于数据的多项式拟合生成的非线性曲线图表，是评估拟合质量的一种强大方式；如下图展示，三次项回归展现出了优良的拟合。

```{r}
# 拟合三次模型
fit_d3 <- lm(nox ~ poly(dis, 3, raw=TRUE), data=Boston)

plot(Boston$dis, Boston$nox)

lines(sort(Boston$dis), 
      fit_d3$fitted.values[order(Boston$dis)],  
      col = 2, 
      lwd = 3)
```

但仅仅是图是不够的，我们还需要看`lm()`返回的每一个多项式次数对应的统计量：

```{r}
# 调整后的R²: 0.7131
summary(fit_d3)


# 返回三次多项式回归模型的系数表；这个命令做了两件事：
  # summary(fit_d3) 生成模型的详细摘要信息
  # coef() 从摘要中提取系数表

# 返回的结果是一个矩阵，包含以下几列：
  # Estimate: 每个系数的估计值
  # Std. Error: 每个系数估计的标准误差
  # t value: t统计量（系数估计除以其标准误差）
  # Pr(>|t|): p值，表示系数显著性
coef(summary(fit_d3))
```

有一些关键的指标如下：

-   **拟合的决定系数（也被称为R^2^）**：表明可以用模型解释的数据集中异常值（变异）的百分比。R^2^ 越接近1，拟合模型越能完整地“解释”数据（的变异）。注意到，随着多项式次数的提高，调整后的决定系数也提高：0.5909、0.6987和0.7131。

-   **拟合的F-统计量（F-statistic）**：比较模型解释的数据变异分数和模型无法解释的数据变异分数的“大小”——即模型变异（可解释变异）和误差（残差：不可解释变异）的比值。F-统计量的值“大”，通常\> 6，表示拟合是有意义的。

-   **回归系数的t-统计量（也称为“t值”）**：表示每一个回归系数的显著性水平——t-统计量定义为回归系数和其标准误差的比值；如果一个回归系数的t值为2或者更高，那么这个回归系数通常是显著的。

#### (2)模型评估与选择

如何确定最适合的多项式次数？主要通过以下方法：

##### 1. 统计指标（R2、F统计量和t统计量的对比）

1.  **拟合的决定系数（也被称为R^2^）**：**确定的某一模型（不是用来比较不同模型的指标，是比较当前模型的指标）**，R2表明可以用模型解释的数据集中异常值（变异）的百分比。R^2^ 越接近1，拟合模型越能完整地“解释”数据（的变异）。注意到，随着多项式次数的提高，调整后的决定系数也提高：0.5909、0.6987和0.7131。

2.  **拟合的F-统计量（F-statistic）**：**不同模型间**，比较**模型整体**解释的数据变异分数和**模型整体**无法解释的数据变异分数的“大小”——即模型变异（可解释变异）和误差（残差：不可解释变异）的比值。F-统计量的值“大”，通常\> 6，表示拟合是有意义的。如果模型调整后F统计值变大，说明模型整体性能进步了。

3.  **回归系数的t-统计量（也称为“t值”）**：**不同模型间**，表示**模型中每一个回归系数的显著性水平**——t-统计量定义为回归系数和其标准误差的比值。如果一个回归系数的t值为2或者更高，那么这个回归系数通常是显著的，回归系数显著不为 0 表示自变量（预测变量）与因变量之间存在统计上显著的关系，这不是偶然的，而是数据中确实存在的模式。

    **在多项式回归的特定情况下，如果高次项（如二次项、三次项）的系数显著不为0，则表明数据中存在非线性关系，简单的线性模型不足以准确描述变量之间的关系——这支持了使用更复杂模型（包含高次项）的决定。**

    **例如，在三次多项式模型中，三次项系数显著不为0表明使用三次曲线比二次曲线更适合描述数据中的关系，证实了模型选择的合理性。**

    -   注意：有人可能因为残差和标准化残差（残差除以残差标准误差）的关系，就认为回归系数和t-统计量（回归系数除以回归系数标准误差）的关系也是类似的；实际上回归系数和标准化回归系数（`回归系数 × (自变量标准差 / 因变量标准差)`）的关系才类似于残差与标准化残差的关系。具体区分如下：

    1.  t统计量与标准化回归系数是两个不同的概念，虽然它们都可以用来评估变量的重要性。

        -   t统计量的计算公式是：`t = 回归系数 / 回归系数的标准误差`

            -   它主要用于检验回归系数是否显著不等于零，衡量的是系数估计值相对于其抽样变异性的大小。t值越大（绝对值意义上），表示该系数越显著不同于零，说明其和因变量的关系就越显著。

        -   而标准化回归系数（也称Beta系数）的计算公式是：`Beta = 回归系数 × (自变量标准差 / 因变量标准差)`

            -   标准化系数表示自变量变动一个标准差时，因变量预期变动的标准差数量，使不同量纲的变量效应可比较。

    2.  主要区别

        -   t统计量：评估系数的统计显著性

        -   标准化系数：对偏回归系数进行标准化，评估不同变量影响的相对大小，允许比较不同单位的变量到底谁对预测因变量的影响更大

##### 2. 方差分析(ANOVA)（基于F统计量比较不同模型）

上面我们已经知道了，不同模型间的拟合效果比较往往基于F统计量（因为其是一个表征不同模型之间、各个模型整体解释变异能力的唯一值），但是两两比较各个模型Summary函数中的F统计量比较低效且麻烦，因此我们可以使用`anova()`函数快速比较不同复杂度的模型，进而看看提升模型的复杂度能不能有效增强模型解释变异的能力（拟合能力）：

`{r} anova(fit_d1, fit_d2, fit_d3)} # 结果显示，从一次到二次，从二次到三次的改进都是显著的(p值<0.05)，表明三次多项式对该数据有最佳拟合效果。`

###### 1、为什么需要确定多项式的次数

1.  **模型复杂度与拟合能力**\
    在多项式回归中，增加多项式的阶数（也就是在模型中加入更高次项）通常会带来更高的拟合能力。因为额外的项可以让模型捕捉更复杂、更细微的非线性关系。

2.  **过度拟合（Overfitting）的风险**\
    虽然更高阶的多项式能更好地“贴近”训练数据，但也更可能出现过度拟合。过度拟合是指模型在训练样本上表现优异，但对新数据的预测性能（泛化能力）较差。换句话说，模型“记住”了数据的噪声和细枝末节，反而失去了对真实关系的把握。

3.  **平衡与取舍**\
    因此，我们需要在模型的复杂度（多项式阶数）与模型的可解释性、泛化能力之间进行平衡。选择一个过于简单的模型（如只有线性项）可能欠拟合，难以捕捉数据的真实结构；选择一个过于复杂的模型（如高阶多项式）又可能过度拟合，无法泛化。

###### 2、如何使用方差分析（ANOVA）比较模型

为了量化评估不同阶数的多项式模型在解释数据方面的表现，我们可以使用方差分析（analysis of variance，ANOVA）。具体步骤如下：

1.  **准备多个候选模型**\
    例如，我们有三个模型：

    -   $\text{fit_d1}$：线性模型（一次多项式）

    -   $\text{fit_d2}$：二次多项式模型

    -   $\text{fit_d3}$：三次多项式模型

2.  **调用 `anova()` 函数比较模型**\
    在 R 语言中，可以通过 `anova(fit_d1, fit_d2, fit_d3)` 的方式，对三个模型进行对照分析。ANOVA 会输出一个表格，其中包括每一个模型相对于前一个模型新增项的显著性检验结果。

3.  **ANOVA 表格解读**\
    在 ANOVA 的输出中，重点关注的是 Pr(\>F) 列（p 值），它用于判断“引入更复杂模型后，解释力是否显著增强”：

    -   **零假设（**H0H_0H0​）：新加入的多项式项不带来显著改善。

    -   **备择假设（**H1H_1H1​）：新加入的多项式项带来显著改善。

    如果某一行（对应某个模型与前一个模型的对比）的 Pr(\>F) 值很小（通常小于 0.05），我们就拒绝零假设，意味着“新模型的加入项确实能显著提高模型对数据的解释能力”。

###### 3、本案例：从线性到二次、再到三次多项式的比较

结合以上思路，我们现在依次比较本例中的三个模型，得到如下结论：

1.  **Model 1（一次多项式）与 Model 2（二次多项式）的比较**

    -   如果 **Model 2（二次多项式）**Pr(\>F) 很小（比如 2.2e-16 远小于 0.05），则说明相较于线性模型（一次多项式），二次多项式显著改善了对数据的拟合效果。

2.  **Model 2（二次多项式）与 Model 3（三次多项式）的比较**

    -   接着比较二次多项式与三次多项式。如果**Model 3（三次多项式）**Pr(\>F) 依然很小，则表示三次多项式在捕捉数据的非线性关系方面做得更好，具有更高的解释力。

3.  **是否继续增加更高阶**

    -   你可能会问：“为什么不继续用四次、五次甚至更高的多项式？”

    -   原因在于：随着阶数的增加，过度拟合的风险越来越大，并且从实践角度看，每增加一阶就需要更多的数据量以支撑模型的稳健性，且解释变得更加困难。通常，三次或四次多项式就已经能很好地捕捉常见的非线性结构，再往上继续增加阶数收效不一定显著，还会失去简洁性和可解释性。

###### 4、核心总结

1.  **模型的阶数决定了模型（拟合）的灵活度**。

2.  **使用 ANOVA** 等方法可以客观地比较不同阶的多项式模型，从而确定更合理的模型复杂度。

3.  **在实践中要警惕过度拟合：**有些时候，通过交叉验证或其他模型评估指标也可判断模型的泛化性能，以此来辅助选择最优的多项式阶数。

4.  **可解释性**也非常重要：从可视化或统计显著性的角度看，当模型复杂度提高，解释难度也会增加，要在模型质量和可解释性之间做好折中。

##### 3. 可视化评估

通过绘制不同次数多项式的拟合曲线，直观评估拟合质量。对Boston数据集而言，三次多项式提供了最佳的拟合曲线。

#### (3)多项式回归的应用注意事项

-   多项式回归适用于探索预测因子的不同曲度等级
-   过高次数的多项式可能导致过拟合
-   需要平衡**模型复杂度/变量数量（正则化）**与**拟合效果（参数估计）：正则化配合参数估计，寻找解释模型变异的最优复杂度+最优参数——即最好的参数配上最适合的变量数量**
-   应结合统计检验和可视化评估选择最佳多项式次数

通过多项式回归，可以有效建模非线性关系，提高预测精度，但需谨慎选择适当的模型复杂度。

### 4 阶段总结

回归是历史最悠久也是人们理解最深入的算法，它在众多领域都有着广泛的使用。截止目前，我们讨论了3种回归形式：一元线性回归、多元线性回归和多项式回归。但这不是回归的结束。还有其他类型的回归算法，例如岭回归（ridge regression）和拉索（lasso）等收缩（shrinkage）方法，用于降低在回归系数趋近于0的情况下产生的误差。

在回归模型使用的过程中，控制模型的复杂度（变量数量）和优化模型的参数以实现拟合训练的最优解，是**模型训练**的核心内容。为此，通过**正则化方法**控制模型的复杂度/变量数量，通过**参数估计**提升模型参数的拟合效果，须二者配合达成平衡才有抵达这最优解的可能——寻找解释模型变异的最优复杂度+最优参数、即**最好的参数配上最适合的变量数量**。

下面是阶段小结：

-   我们从使用R中的lm()函数提供的最小二乘计算工具开始，探索一元线性回归。

    -   在summary()函数的帮助下，我们评估了一系列模型拟合的评估和诊断措施，例如模型的拟合值、回归系数、残差、标准误差、t值、假设几率（\|Pr\|\>t）和F-统计量

    -   我们发现一旦训练了模型，就可以用新数据进行预测。

    -   我们探索了一系列评估模型拟合质量的重要图表：残差-拟合值图、Q-Q图、Cook‘s距离图等

-   然后我们学习了如何将一元线性回归算法扩展到使用多元线性回归的多元预测因子：在这里，我们使用了一种机器学习常用的技术，即将数据集拆分成训练集和测试集。

    -   我们也用一元线性回归中的相同方法来评估模型的拟合程度，同时也看了一些新的诊断图：例如残差-索引图（目的有点类似于Cook's距离图）。

-   为了处理响应变量和预测因子之间的非线性关系，我们的注意力转向了多项式回归，并探索了不同幂次的多项式如何提升拟合的质量。

### 5 多元多项式回归方法

#### 1. 基本概念与数学模型

多元多项式回归是将多元回归和多项式回归结合的统计方法，其数学模型为：

$y = β₀ + β₁x₁ + β₂x₂ + ... + β₁₁x₁² + β₂₂x₂² + ... + β₁₂x₁x₂ + ... + ε$

这种模型包含： - 线性项：β₁x₁, β₂x₂, ... - 二次项：β₁₁x₁², β₂₂x₂², ... - 交互项：β₁₂x₁x₂, ...

此模型通过高次项捕捉非线性关系，通过交互项分析变量间相互作用。

#### 2. 构建与实现步骤

##### 1、特征构建

-   从原始变量生成多项式特征
-   确定多项式阶数（一般从2阶开始尝试）
-   生成交互项特征

##### 2、参数估计

-   通常采用普通最小二乘法(OLS)估计参数
-   可转化为矩阵形式求解：β = (X\^T X)\^(-1) X\^T y

##### 3、模型选择

-   使用逐步回归方法筛选变量
-   应用信息准则（如AIC、BIC）评估模型
-   使用交叉验证选择最佳阶数

#### 3. 编程实现方法

Python实现示例：

```{python}
# 使用scikit-learn库
from sklearn.preprocessing import PolynomialFeatures
from sklearn.linear_model import LinearRegression
from sklearn.pipeline import Pipeline

# 创建多项式特征转换器和线性回归模型的管道
model = Pipeline([
    ('poly', PolynomialFeatures(degree=2, include_bias=False)),
    ('linear', LinearRegression())
])

# 拟合模型
model.fit(X, y)
```

R语言实现示例：

```{r}
# 创建多项式回归模型
model <- lm(y ~ poly(x1, 2) + poly(x2, 2) + x1:x2, data=df)
```

#### 4. 模型评估与诊断

##### 1、拟合优度评估

-   决定系数(R²)和调整后的R²
-   均方误差(MSE)和均方根误差(RMSE)
-   F统计量检验整体显著性

##### 2、残差分析

-   残差的正态性检验
-   残差图检查同方差性
-   检测异常值和高杠杆点

##### 3、多重共线性诊断

-   计算方差膨胀因子(VIF)
-   使用主成分分析或岭回归应对多重共线性

#### 5. 优势与局限性

##### 优势

-   能够捕捉复杂的非线性关系
-   保持了线性回归的可解释性

##### 局限性

-   特征数量随变量数和阶数指数增长
-   容易出现过拟合问题
-   模型复杂度增加导致解释难度增大
-   对异常值敏感度高

#### 6. 实际应用领域与案例

-   经济与金融
    -   股票价格非线性预测
    -   宏观经济指标关系建模
-   工程与制造
    -   产品质量与多因素关系分析
    -   工艺参数优化
-   生物医学
    -   药物剂量与效应的非线性关系
    -   多基因交互作用分析
-   环境科学
    -   气候因素与污染物浓度关系
    -   生态系统多因素互动模型
